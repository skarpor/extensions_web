{% extends "base.html" %}

{% block title %}å®æ—¶èŠå¤©{% endblock %}

{% block additional_css %}
<style>
  :root {
    --chat-primary: #4e73df;
    --chat-bg: #f8f9fa;
    --chat-border: #e3e6f0;
    --chat-text: #333;
    --chat-self-bg: #4e73df;
    --chat-self-text: white;
    --chat-other-bg: #f0f0f0;
    --chat-other-text: #333;
    --chat-status-bg: #e9ecef;
    --chat-status-text: #6c757d;
    --chat-hover: #eaecf4;
    --chat-active: #dddfeb;
    --chat-unread: #e74a3b;
  }

  .chat-container {
    height: calc(100vh - 150px);
    min-height: 500px;
    border-radius: 10px;
    overflow: hidden;
    border: 1px solid var(--chat-border);
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.1);
  }
  
  .chat-sidebar {
    background-color: white;
    border-right: 1px solid var(--chat-border);
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  
  .rooms-header, .users-header {
    padding: 15px;
    border-bottom: 1px solid var(--chat-border);
    font-weight: bold;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .room-list, .user-list {
    overflow-y: auto;
    flex-grow: 1;
  }
  
  .room-item, .user-item {
    padding: 10px 15px;
    border-bottom: 1px solid var(--chat-border);
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background-color 0.2s;
  }
  
  .room-item:hover, .user-item:hover {
    background-color: var(--chat-hover);
  }
  
  .room-item.active, .user-item.active {
    background-color: var(--chat-active);
  }
  
  .room-item .badge, .user-item .badge {
    margin-left: auto;
  }
  
  .room-avatar, .user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    background-color: #e0e0e0;
  }
  
  .room-info, .user-info {
    flex-grow: 1;
    min-width: 0;
  }
  
  .room-name, .user-name {
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .room-last-message, .user-status {
    font-size: 0.8em;
    color: #6c757d;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .tabs-container {
    border-bottom: 1px solid var(--chat-border);
  }
  
  .chat-tabs {
    display: flex;
  }
  
  .chat-tab {
    padding: 15px;
    flex-grow: 1;
    text-align: center;
    cursor: pointer;
    font-weight: bold;
    border-bottom: 3px solid transparent;
    transition: all 0.2s;
  }
  
  .chat-tab.active {
    border-bottom-color: var(--chat-primary);
    color: var(--chat-primary);
  }
  
  .chat-main {
    display: flex;
    flex-direction: column;
    height: 100%;
    background-color: #fff;
  }
  
  .chat-header {
    padding: 15px;
    border-bottom: 1px solid var(--chat-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background-color: white;
  }
  
  .chat-header-info {
    display: flex;
    align-items: center;
  }
  
  .chat-header-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 15px;
  }
  
  .chat-header-name {
    font-weight: bold;
    font-size: 1.1em;
  }
  
  .chat-header-status {
    font-size: 0.8em;
    color: #6c757d;
  }
  
  .chat-header-actions .btn {
    margin-left: 10px;
  }
  
  .chat-window {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    background-color: var(--chat-bg);
  }
  
  .chat-message {
    margin-bottom: 15px;
    display: flex;
    flex-direction: column;
    max-width: 75%;
    clear: both;
  }
  
  .message-self {
    align-items: flex-end;
    float: right;
  }
  
  .message-other {
    align-items: flex-start;
    float: left;
  }
  
  .message-content {
    padding: 10px 15px;
    border-radius: 18px;
    position: relative;
    word-break: break-word;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  
  .message-self .message-content {
    background-color: var(--chat-self-bg);
    color: var(--chat-self-text);
    border-bottom-right-radius: 5px;
  }
  
  .message-other .message-content {
    background-color: var(--chat-other-bg);
    color: var(--chat-other-text);
    border-bottom-left-radius: 5px;
  }
  
  .message-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
  }
  
  .message-avatar {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
  }
  
  .message-username {
    font-weight: bold;
    font-size: 0.9em;
  }
  
  .message-time {
    font-size: 0.7em;
    margin-top: 5px;
    opacity: 0.7;
  }
  
  .message-image {
    max-width: 100%;
    max-height: 300px;
    border-radius: 10px;
    margin-top: 5px;
    cursor: pointer;
  }
  
  .message-status {
    text-align: center;
    padding: 8px 12px;
    margin: 10px 0;
    font-size: 0.8em;
    color: var(--chat-status-text);
    background-color: var(--chat-status-bg);
    border-radius: 10px;
    clear: both;
    max-width: 70%;
    margin-left: auto;
    margin-right: auto;
  }
  
  .typing-indicator {
    text-align: center;
    padding: 5px;
    font-style: italic;
    color: #6c757d;
    visibility: hidden;
    clear: both;
  }
  
  .typing-indicator.visible {
    visibility: visible;
  }
  
  .chat-input {
    padding: 15px;
    border-top: 1px solid var(--chat-border);
    background-color: white;
  }
  
  .chat-input-container {
    display: flex;
    align-items: center;
  }
  
  .chat-input-actions {
    display: flex;
    margin-right: 10px;
  }
  
  .chat-input-action {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: background-color 0.2s;
    color: #6c757d;
  }
  
  .chat-input-action:hover {
    background-color: var(--chat-hover);
    color: var(--chat-primary);
  }
  
  .chat-input-box {
    flex-grow: 1;
    position: relative;
  }
  
  #messageInput {
    padding-right: 50px;
    resize: none;
    border-radius: 20px;
    height: 40px;
    max-height: 120px;
    overflow-y: auto;
  }
  
  .chat-send-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    background-color: var(--chat-primary);
    color: white;
    margin-left: 10px;
  }
  
  .chat-send-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  
  .emoji-panel {
    display: none;
    position: absolute;
    bottom: 45px;
    left: 0;
    width: 250px;
    height: 200px;
    background-color: white;
    border: 1px solid var(--chat-border);
    border-radius: 5px;
    padding: 10px;
    z-index: 1000;
    overflow-y: auto;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
  }
  
  .emoji-grid {
    display: grid;
    grid-template-columns: repeat(6, 1fr);
    gap: 5px;
  }
  
  .emoji-item {
    font-size: 1.5em;
    text-align: center;
    cursor: pointer;
    user-select: none;
    padding: 5px;
    border-radius: 5px;
  }
  
  .emoji-item:hover {
    background-color: var(--chat-hover);
  }
  
  /* Create room modal */
  .modal-header {
    background-color: var(--chat-primary);
    color: white;
  }
  
  .modal-footer .btn-primary {
    background-color: var(--chat-primary);
    border-color: var(--chat-primary);
  }
  
  /* Badge for unread messages */
  .unread-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background-color: var(--chat-unread);
    color: white;
    font-size: 0.7em;
    font-weight: bold;
  }
  
  /* Welcome message */
  .welcome-message {
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 20px;
    color: #6c757d;
  }
  
  .welcome-icon {
    font-size: 4em;
    color: var(--chat-primary);
    margin-bottom: 20px;
  }
  
  .welcome-title {
    font-size: 1.5em;
    font-weight: bold;
    margin-bottom: 10px;
  }
  
  .welcome-text {
    max-width: 500px;
    margin-bottom: 20px;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .chat-sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      z-index: 1050;
      transition: left 0.3s;
    }
    
    .chat-sidebar.show {
      left: 0;
    }
    
    .sidebar-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.5);
      z-index: 1040;
    }
    
    .sidebar-backdrop.show {
      display: block;
    }
    
    .chat-main {
      width: 100%;
    }
    
    .toggle-sidebar {
      display: inline-block !important;
    }
  }
  
  .toggle-sidebar {
    display: none;
  }
  
  /* Image preview */
  .image-preview {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0,0,0,0.8);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  
  .image-preview img {
    max-width: 90%;
    max-height: 90%;
    border-radius: 5px;
  }
  
  .close-preview {
    position: absolute;
    top: 20px;
    right: 20px;
    color: white;
    font-size: 2em;
    cursor: pointer;
  }
</style>
{% endblock %}

{% block content %}
<!-- å›¾ç‰‡é¢„è§ˆ -->
<div class="image-preview" id="imagePreview">
  <div class="close-preview" id="closePreview">&times;</div>
  <img src="" id="previewImage" alt="é¢„è§ˆå›¾ç‰‡">
</div>

<!-- èŠå¤©å®¹å™¨ -->
<div class="row">
  <div class="col-12">
    <div class="chat-container d-flex">
      <!-- ä¾§è¾¹æ  -->
      <div class="chat-sidebar" id="chatSidebar">
        <div class="tabs-container">
          <div class="chat-tabs">
            <div class="chat-tab active" data-tab="rooms">èŠå¤©å®¤</div>
            <div class="chat-tab" data-tab="users">ç”¨æˆ·</div>
        </div>
        </div>
        
        <!-- èŠå¤©å®¤åˆ—è¡¨ -->
        <div class="tab-content" id="roomsTab">
          <div class="rooms-header">
            <span>æˆ‘çš„èŠå¤©å®¤</span>
            <button class="btn btn-sm btn-primary" id="createRoomBtn">
              <i class="fas fa-plus"></i>
          </button>
        </div>
          <div class="room-list" id="roomList">
            <!-- èŠå¤©å®¤åˆ—è¡¨é¡¹å°†åŠ¨æ€æ·»åŠ  -->
          </div>
      </div>
      
        <!-- ç”¨æˆ·åˆ—è¡¨ -->
        <div class="tab-content" id="usersTab" style="display: none;">
          <div class="users-header">
            <span>åœ¨çº¿ç”¨æˆ·</span>
            <span id="onlineCount" class="badge badge-primary">0</span>
          </div>
          <div class="user-list" id="userList">
            <!-- ç”¨æˆ·åˆ—è¡¨é¡¹å°†åŠ¨æ€æ·»åŠ  -->
          </div>
        </div>
      </div>
      
      <!-- ä¾§è¾¹æ èƒŒæ™¯é®ç½© (ç§»åŠ¨ç«¯) -->
      <div class="sidebar-backdrop" id="sidebarBackdrop"></div>
      
      <!-- ä¸»èŠå¤©åŒºåŸŸ -->
      <div class="chat-main flex-grow-1">
        <!-- åˆå§‹æ¬¢è¿æ¶ˆæ¯ -->
        <div class="welcome-message" id="welcomeMessage">
          <div class="welcome-icon">
            <i class="fas fa-comments"></i>
          </div>
          <h3 class="welcome-title">æ¬¢è¿ä½¿ç”¨å®æ—¶èŠå¤©ç³»ç»Ÿ</h3>
          <p class="welcome-text">
            è¯·ä»å·¦ä¾§é€‰æ‹©ä¸€ä¸ªèŠå¤©å®¤æˆ–ç”¨æˆ·å¼€å§‹èŠå¤©ã€‚æ‚¨ä¹Ÿå¯ä»¥åˆ›å»ºè‡ªå·±çš„èŠå¤©å®¤æˆ–ä¸å…¶ä»–åœ¨çº¿ç”¨æˆ·ç§èŠã€‚
          </p>
          <button class="btn btn-primary" id="createRoomBtnWelcome">
            <i class="fas fa-plus mr-2"></i> åˆ›å»ºèŠå¤©å®¤
          </button>
      </div>
        
        <!-- èŠå¤©ç•Œé¢ (åˆå§‹éšè—) -->
        <div id="chatInterface" style="display: none; height: 100%;">
          <div class="chat-header">
            <div class="chat-header-info">
              <button class="toggle-sidebar btn btn-sm btn-light mr-2">
                <i class="fas fa-bars"></i>
              </button>
              <img src="" alt="" class="chat-header-avatar" id="currentChatAvatar">
              <div>
                <div class="chat-header-name" id="currentChatName"></div>
                <div class="chat-header-status" id="currentChatStatus"></div>
              </div>
            </div>
            <div class="chat-header-actions">
              <button class="btn btn-sm btn-outline-secondary" id="viewMembersBtn">
                <i class="fas fa-users"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary" id="clearChatBtn">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          
          <div class="chat-window" id="chatWindow">
            <!-- æ¶ˆæ¯å°†åŠ¨æ€æ·»åŠ  -->
          </div>
          
          <div class="typing-indicator" id="typingIndicator">æœ‰äººæ­£åœ¨è¾“å…¥...</div>
      
      <div class="chat-input">
            <form id="messageForm">
              <div class="chat-input-container">
                <div class="chat-input-actions">
                  <div class="chat-input-action" id="emojiBtn">
                    <i class="far fa-smile"></i>
                  </div>
                  <div class="chat-input-action" id="imageBtn">
                    <i class="far fa-image"></i>
                  </div>
                </div>
                <div class="chat-input-box">
                  <textarea class="form-control" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
                <div class="emoji-panel" id="emojiPanel">
                  <div class="emoji-grid">
                    <div class="emoji-item">ğŸ˜Š</div>
                    <div class="emoji-item">ğŸ˜‚</div>
                    <div class="emoji-item">ğŸ˜</div>
                    <div class="emoji-item">ğŸ¤”</div>
                    <div class="emoji-item">ğŸ˜</div>
                    <div class="emoji-item">ğŸ˜¢</div>
                    <div class="emoji-item">ğŸ˜¡</div>
                    <div class="emoji-item">ğŸ‘</div>
                    <div class="emoji-item">ğŸ‘</div>
                    <div class="emoji-item">â¤ï¸</div>
                    <div class="emoji-item">ğŸ‘</div>
                    <div class="emoji-item">ğŸ™</div>
                    <div class="emoji-item">ğŸ‰</div>
                    <div class="emoji-item">ğŸŒŸ</div>
                    <div class="emoji-item">ğŸ”¥</div>
                    <div class="emoji-item">ğŸ’¯</div>
                    <div class="emoji-item">ğŸ¤£</div>
                    <div class="emoji-item">ğŸ˜­</div>
                  </div>
                </div>
                  <input type="file" id="imageInput" accept="image/*" style="display: none;">
              </div>
                <button type="submit" class="chat-send-btn">
                  <i class="fas fa-paper-plane"></i>
                </button>
            </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- åˆ›å»ºèŠå¤©å®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="createRoomModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">åˆ›å»ºèŠå¤©å®¤</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="createRoomForm">
          <div class="form-group">
            <label for="roomName">èŠå¤©å®¤åç§°</label>
            <input type="text" class="form-control" id="roomName" required>
          </div>
          <div class="form-group">
            <label for="roomDescription">æè¿°</label>
            <textarea class="form-control" id="roomDescription" rows="3"></textarea>
          </div>
          <div class="form-group">
            <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="roomIsPrivate">
              <label class="custom-control-label" for="roomIsPrivate">ç§å¯†èŠå¤©å®¤</label>
              <small class="form-text text-muted">ç§å¯†èŠå¤©å®¤åªå¯¹å—é‚€ç”¨æˆ·å¯è§</small>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" id="saveRoomBtn">åˆ›å»º</button>
      </div>
      </div>
    </div>
  </div>
  
<!-- æŸ¥çœ‹æˆå‘˜æ¨¡æ€æ¡† -->
<div class="modal fade" id="membersModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">èŠå¤©å®¤æˆå‘˜</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <ul class="list-group" id="membersList">
          <!-- æˆå‘˜åˆ—è¡¨å°†åŠ¨æ€æ·»åŠ  -->
        </ul>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
      </div>
        </div>
      </div>
    </div>
    
<!-- èŠå¤©è®¾ç½®æ¨¡æ€æ¡† -->
<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">èŠå¤©è®¾ç½®</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="settingsForm">
          <div class="form-group">
            <label for="userNickname">æ˜µç§°</label>
            <input type="text" class="form-control" id="userNickname">
            <small class="form-text text-muted">ç•™ç©ºå°†ä½¿ç”¨ç³»ç»Ÿç”¨æˆ·å</small>
          </div>
          <div class="form-group">
            <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="soundEnabled" checked>
          <label class="custom-control-label" for="soundEnabled">æ¶ˆæ¯æç¤ºéŸ³</label>
        </div>
          </div>
          <div class="form-group">
            <div class="custom-control custom-switch">
          <input type="checkbox" class="custom-control-input" id="showTimestamp" checked>
          <label class="custom-control-label" for="showTimestamp">æ˜¾ç¤ºæ—¶é—´æˆ³</label>
        </div>
        </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button>
        <button type="button" class="btn btn-primary" id="saveSettingsBtn">ä¿å­˜</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block additional_scripts %}
<script>
  // ===== å…¨å±€å˜é‡ =====
  let ws;
  let username = '{{ user.username }}';
  let nickname = '{{ user.nickname }}' || username;
  let userId = parseInt('{{ user.id }}');
  let currentRoomId = null;
  let currentChatType = null; // 'room' æˆ– 'private'
  let currentChatId = null;
  let isConnected = false;
  let isTyping = false;
  let typingTimeout;
  let lastTypingTime = 0;
  const TYPING_TIMER_LENGTH = 3000; // 3ç§’
  let rooms = {}; // èŠå¤©å®¤ä¿¡æ¯ï¼š{id: {name, description, is_private, ...}}
  let users = {}; // ç”¨æˆ·ä¿¡æ¯ï¼š{id: {username, nickname, online, ...}}
  let unreadMessages = {}; // æœªè¯»æ¶ˆæ¯è®¡æ•°ï¼š{room_id: count, user_id: count}
  let messageHistory = {}; // æ¶ˆæ¯å†å²ï¼š{room_id: [messages], user_id: [messages]}
  
  // é¡µé¢åŠ è½½å®Œæˆ
  $(document).ready(function() {
    // åˆå§‹åŒ–UI
    initUI();
    
    // åŠ è½½ç”¨æˆ·è®¾ç½®
    loadUserSettings();
    
    // è¿æ¥WebSocket
    connectWebSocket();
    
    // è·å–èŠå¤©å®¤åˆ—è¡¨
    fetchChatRooms();
    
    // ç»‘å®šäº‹ä»¶å¤„ç†
    bindEvents();
  });
  
  // ===== åˆå§‹åŒ–å’Œé…ç½® =====
  
  // åˆå§‹åŒ–UI
  function initUI() {
    // è°ƒæ•´èŠå¤©çª—å£é«˜åº¦
    adjustChatHeight();
    $(window).on('resize', adjustChatHeight);
    
    // ç§»åŠ¨ç«¯ä¾§è¾¹æ åˆ‡æ¢
    $('.toggle-sidebar').on('click', toggleSidebar);
    $('#sidebarBackdrop').on('click', toggleSidebar);
    
    // é€‰é¡¹å¡åˆ‡æ¢
    $('.chat-tab').on('click', function() {
      $('.chat-tab').removeClass('active');
      $(this).addClass('active');
      
      const tab = $(this).data('tab');
      $('.tab-content').hide();
      $(`#${tab}Tab`).show();
    });
    
    // è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
    $('#messageInput').on('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight < 120 ? this.scrollHeight : 120) + 'px';
    });
  }
  
  // è°ƒæ•´èŠå¤©çª—å£é«˜åº¦
  function adjustChatHeight() {
    const windowHeight = window.innerHeight;
    const headerHeight = $('nav').outerHeight();
    const footerHeight = $('footer').outerHeight() || 0;
    const containerPadding = 50;
    
    $('.chat-container').css('height', (windowHeight - headerHeight - footerHeight - containerPadding) + 'px');
  }
  
  // è·å–ç”¨æˆ·å¤´åƒURL
  function getUserAvatarUrl(username, nickname, size = 128) {
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(nickname || username)}&background=random&color=fff&size=${size}`;
  }
  
  // è·å–èŠå¤©å®¤å¤´åƒURL
  function getRoomAvatarUrl(name, size = 128) {
    return `https://ui-avatars.com/api/?name=${encodeURIComponent(name)}&background=4e73df&color=fff&size=${size}`;
  }
  
  // åˆ‡æ¢ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
  function toggleSidebar() {
    $('#chatSidebar').toggleClass('show');
    $('#sidebarBackdrop').toggleClass('show');
  }
  
  // æ˜¾ç¤ºToastæ¶ˆæ¯
  function showToast(message) {
    // åˆ›å»ºToastå…ƒç´ 
    const toast = $(`
      <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
        <div class="toast-header">
          <strong class="mr-auto">æç¤º</strong>
          <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body">
          ${message}
        </div>
      </div>
    `);
    
    // æ·»åŠ åˆ°é¡µé¢
    if ($('#toastContainer').length === 0) {
      $('body').append('<div id="toastContainer" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>');
    }
    
    $('#toastContainer').append(toast);
    
    // æ˜¾ç¤ºToast
    toast.toast('show');
    
    // è‡ªåŠ¨ç§»é™¤
    toast.on('hidden.bs.toast', function() {
      $(this).remove();
    });
  }
  
  // ç»‘å®šäº‹ä»¶å¤„ç†
  function bindEvents() {
    // è¡¨å•æäº¤
    $('#messageForm').on('submit', function(e) {
      e.preventDefault();
      sendMessage();
    });
    
    // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–æ¥å‘é€æ­£åœ¨è¾“å…¥çŠ¶æ€
    $('#messageInput').on('input', handleTypingStatus);
    
    // æ‰“å¼€/å…³é—­Emojié¢æ¿
    $('#emojiBtn').on('click', function() {
      $('#emojiPanel').toggle();
    });
    
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­emojié¢æ¿
    $(document).on('click', function(e) {
      if (!$(e.target).closest('#emojiBtn, #emojiPanel').length) {
        $('#emojiPanel').hide();
      }
    });
    
    // æ’å…¥emoji
    $('.emoji-item').on('click', function() {
      const emoji = $(this).text();
      const input = $('#messageInput');
      input.val(input.val() + emoji);
      input.focus();
      // è§¦å‘inputäº‹ä»¶æ¥è‡ªåŠ¨è°ƒæ•´é«˜åº¦
      input.trigger('input');
    });
    
    // å›¾ç‰‡ä¸Šä¼ 
    $('#imageBtn').on('click', function() {
      $('#imageInput').click();
    });
    
    $('#imageInput').on('change', function(e) {
      if (e.target.files.length > 0) {
        uploadImage(e.target.files[0]);
      }
    });
    
    // æ¸…ç©ºèŠå¤©
    $('#clearChatBtn').on('click', function() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºèŠå¤©è®°å½•å—ï¼Ÿè¿™å°†åªæ¸…ç©ºæ‚¨çš„æœ¬åœ°æ˜¾ç¤ºï¼Œä¸ä¼šåˆ é™¤æœåŠ¡å™¨ä¸Šçš„æ¶ˆæ¯ã€‚')) {
        $('#chatWindow').html('');
        if (currentChatId) {
          messageHistory[currentChatId] = [];
        }
      }
    });
    
    // åˆ›å»ºèŠå¤©å®¤æŒ‰é’®
    $('#createRoomBtn, #createRoomBtnWelcome').on('click', function() {
      $('#createRoomModal').modal('show');
    });
    
    // ä¿å­˜èŠå¤©å®¤æŒ‰é’®
    $('#saveRoomBtn').on('click', createChatRoom);
    
    // æŸ¥çœ‹æˆå‘˜æŒ‰é’®
    $('#viewMembersBtn').on('click', function() {
      if (currentChatType === 'room') {
        fetchRoomMembers(currentRoomId);
        $('#membersModal').modal('show');
      }
    });
    
    // å›¾ç‰‡é¢„è§ˆ
    $(document).on('click', '.message-image', function() {
      const imgSrc = $(this).attr('src');
      $('#previewImage').attr('src', imgSrc);
      $('#imagePreview').css('display', 'flex');
    });
    
    $('#closePreview').on('click', function() {
      $('#imagePreview').hide();
    });
    
    // ä¿å­˜è®¾ç½®æŒ‰é’®
    $('#saveSettingsBtn').on('click', saveUserSettings);
    
    // ç‚¹å‡»èŠå¤©å®¤
    $(document).on('click', '.room-item', function() {
      const roomId = $(this).data('id');
      openChat('room', roomId);
    });
    
    // ç‚¹å‡»ç”¨æˆ·
    $(document).on('click', '.user-item', function() {
      const userId = $(this).data('id');
      // ä¸èƒ½å’Œè‡ªå·±èŠå¤©
      if (userId === parseInt('{{ user.id }}')) {
        showToast('æ— æ³•ä¸è‡ªå·±è¿›è¡Œç§èŠ');
        return;
      }
      openChat('private', userId);
    });
  }
  
  // åŠ è½½ç”¨æˆ·è®¾ç½®
  function loadUserSettings() {
    // åŠ è½½æ˜µç§°
    const savedNickname = localStorage.getItem('chat_nickname');
    if (savedNickname) {
      nickname = savedNickname;
      $('#userNickname').val(savedNickname);
    }
    
    // åŠ è½½æ—¶é—´æˆ³è®¾ç½®
    const showTimestamp = localStorage.getItem('chat_show_timestamp') !== 'false';
    $('#showTimestamp').prop('checked', showTimestamp);
    
    // åŠ è½½å£°éŸ³è®¾ç½®
    const soundEnabled = localStorage.getItem('chat_sound_enabled') !== 'false';
    $('#soundEnabled').prop('checked', soundEnabled);
  }
  
  // ä¿å­˜ç”¨æˆ·è®¾ç½®
  function saveUserSettings() {
    const newNickname = $('#userNickname').val().trim() || username;
    const showTimestamp = $('#showTimestamp').is(':checked');
    const soundEnabled = $('#soundEnabled').is(':checked');
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    localStorage.setItem('chat_nickname', newNickname);
    localStorage.setItem('chat_show_timestamp', showTimestamp);
    localStorage.setItem('chat_sound_enabled', soundEnabled);
    
    // æ›´æ–°æ˜µç§°
    if (nickname !== newNickname) {
      nickname = newNickname;
      
      // é€šçŸ¥æœåŠ¡å™¨æ˜µç§°å˜æ›´
      if (isConnected) {
        ws.send(JSON.stringify({
          type: 'nickname',
          nickname: nickname
        }));
      }
    }
    
    // æ›´æ–°æ—¶é—´æˆ³æ˜¾ç¤º
      $('.message-time').toggle(showTimestamp);
    
    $('#settingsModal').modal('hide');
    
    // æ˜¾ç¤ºæç¤º
    showToast('è®¾ç½®å·²ä¿å­˜');
  }
  
  // ===== èŠå¤©ç•Œé¢æ“ä½œ =====
  
  // æ‰“å¼€èŠå¤©
  function openChat(type, id) {
    // å¦‚æœæ˜¯å½“å‰èŠå¤©ï¼Œä¸åšä»»ä½•æ“ä½œ
    if (currentChatType === type && currentChatId === id) {
      return;
    }
    
    // å¦‚æœæœ‰å½“å‰èŠå¤©ï¼Œç¦»å¼€å½“å‰èŠå¤©å®¤
    if (currentChatType === 'room' && currentChatId) {
      leaveRoom(currentChatId);
    }
    
    // æ›´æ–°å½“å‰èŠå¤©ä¿¡æ¯
    currentChatType = type;
    currentChatId = id;
    
    if (type === 'room') {
      currentRoomId = id;
      const room = rooms[id];
      
      // åŠ å…¥èŠå¤©å®¤
      joinRoom(id);
      
      // æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜
      $('#currentChatAvatar').attr('src', getRoomAvatarUrl(room.name));
      $('#currentChatName').text(room.name);
      $('#currentChatStatus').text(room.description || '');
      
      // æ˜¾ç¤º/éšè—æˆå‘˜æŒ‰é’®
      $('#viewMembersBtn').show();
    } else {
      const user = users[id];
      
      // æ›´æ–°èŠå¤©ç•Œé¢æ ‡é¢˜
      $('#currentChatAvatar').attr('src', getUserAvatarUrl(user.username, user.nickname));
      $('#currentChatName').text(user.nickname || user.username);
      $('#currentChatStatus').text(user.online ? 'åœ¨çº¿' : 'ç¦»çº¿');
      
      // éšè—æˆå‘˜æŒ‰é’®
      $('#viewMembersBtn').hide();
    }
    
    // æ¸…ç©ºèŠå¤©çª—å£
    $('#chatWindow').empty();
    
    // æ˜¾ç¤ºèŠå¤©ç•Œé¢
    $('#welcomeMessage').hide();
    $('#chatInterface').show();
    
    // æ˜¾ç¤ºå†å²æ¶ˆæ¯
    if (messageHistory[id]) {
      for (const message of messageHistory[id]) {
        appendChatMessage(message);
      }
    }
    
    // æ¸…é™¤æœªè¯»æ¶ˆæ¯è®¡æ•°
    unreadMessages[id] = 0;
    updateUnreadBadge(id);
    
    // æ»šåŠ¨åˆ°åº•éƒ¨
    scrollToBottom();
    
    // ç§»åŠ¨ç«¯è‡ªåŠ¨éšè—ä¾§è¾¹æ 
    if (window.innerWidth < 768) {
      toggleSidebar();
    }
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    $('#messageInput').focus();
  }
  
  // æ›´æ–°æœªè¯»æ¶ˆæ¯å¾½ç« 
  function updateUnreadBadge(chatId) {
    const count = unreadMessages[chatId] || 0;
    const selector = currentChatType === 'room' 
      ? `.room-item[data-id="${chatId}"] .unread-badge` 
      : `.user-item[data-id="${chatId}"] .unread-badge`;
    
    if (count > 0) {
      // æ˜¾ç¤ºæœªè¯»å¾½ç« 
      if ($(selector).length === 0) {
        const badgeHtml = `<span class="unread-badge">${count}</span>`;
        if (currentChatType === 'room') {
          $(`.room-item[data-id="${chatId}"]`).append(badgeHtml);
        } else {
          $(`.user-item[data-id="${chatId}"]`).append(badgeHtml);
        }
      } else {
        $(selector).text(count);
      }
    } else {
      // ç§»é™¤æœªè¯»å¾½ç« 
      $(selector).remove();
    }
  }
  
  // æ›´æ–°èŠå¤©å®¤åˆ—è¡¨
  function updateRoomsList(roomsList) {
    const roomList = $('#roomList');
    roomList.empty();
    
    if (roomsList.length === 0) {
      roomList.html('<div class="p-3 text-center text-muted">æ²¡æœ‰å¯ç”¨çš„èŠå¤©å®¤</div>');
      return;
    }
    
    roomsList.forEach(function(room) {
      rooms[room.id] = room;
      
      const isActive = currentChatType === 'room' && currentChatId === room.id;
      const roomHtml = `
        <div class="room-item ${isActive ? 'active' : ''}" data-id="${room.id}">
          <img src="${getRoomAvatarUrl(room.name)}" class="room-avatar" alt="${room.name}">
          <div class="room-info">
            <div class="room-name">${room.name}</div>
            <div class="room-last-message">${room.description || ''}</div>
          </div>
          ${unreadMessages[room.id] ? `<span class="unread-badge">${unreadMessages[room.id]}</span>` : ''}
        </div>
      `;
      roomList.append(roomHtml);
    });
  }
  
  // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
  function updateUsersList(usersList) {
    const userList = $('#userList');
    userList.empty();
    
    if (usersList.length === 0) {
      userList.html('<div class="p-3 text-center text-muted">æ²¡æœ‰åœ¨çº¿ç”¨æˆ·</div>');
      $('#onlineCount').text('0');
      return;
    }
    
    // æ›´æ–°åœ¨çº¿ç”¨æˆ·æ•°
    const onlineCount = usersList.filter(user => user.online).length;
    $('#onlineCount').text(onlineCount.toString());
    
    usersList.forEach(function(user) {
      // è·³è¿‡è‡ªå·±
      if (user.username === username) {
        return;
      }
      
      users[user.id] = user;
      
      const isActive = currentChatType === 'private' && currentChatId === user.id;
      const statusClass = user.online ? 'status-online' : 'status-offline';
      const userHtml = `
        <div class="user-item ${isActive ? 'active' : ''}" data-id="${user.id}">
          <img src="${getUserAvatarUrl(user.username, user.nickname)}" class="user-avatar" alt="${user.nickname || user.username}">
          <div class="user-info">
            <div class="user-name">${user.nickname || user.username}</div>
            <div class="user-status"><span class="online-status ${statusClass}"></span> ${user.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</div>
          </div>
          ${unreadMessages[user.id] ? `<span class="unread-badge">${unreadMessages[user.id]}</span>` : ''}
        </div>
      `;
      userList.append(userHtml);
    });
  }
  
  // æ›´æ–°æˆå‘˜åˆ—è¡¨
  function updateMembersList(members) {
    const membersList = $('#membersList');
    membersList.empty();
    
    if (members.length === 0) {
      membersList.html('<li class="list-group-item text-center">æ²¡æœ‰æˆå‘˜</li>');
      return;
    }
    
    members.forEach(function(member) {
      const statusClass = member.online ? 'status-online' : 'status-offline';
      const memberHtml = `
        <li class="list-group-item d-flex align-items-center">
          <img src="${getUserAvatarUrl(member.username, member.nickname)}" class="mr-3" style="width: 30px; height: 30px; border-radius: 50%;" alt="${member.nickname || member.username}">
          <div>
            <div>${member.nickname || member.username}</div>
            <small><span class="online-status ${statusClass}"></span> ${member.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}</small>
          </div>
        </li>
      `;
      membersList.append(memberHtml);
    });
  }
  
  // ===== WebSocketè¿æ¥å’Œæ¶ˆæ¯å¤„ç† =====
  
  // è¿æ¥WebSocket
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/chat/${username}`;
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
      isConnected = true;
      showToast('å·²è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨');
      
      // å‘é€ç”¨æˆ·ä¿¡æ¯
      ws.send(JSON.stringify({
        type: 'user_info',
        nickname: nickname
      }));
      
      // å¦‚æœå½“å‰åœ¨èŠå¤©å®¤ä¸­ï¼Œé‡æ–°åŠ å…¥
      if (currentChatType === 'room' && currentRoomId) {
        joinRoom(currentRoomId);
      }
    };
    
    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      handleMessage(data);
    };
    
    ws.onclose = function() {
      isConnected = false;
      showToast('å·²æ–­å¼€è¿æ¥ï¼Œæ­£åœ¨å°è¯•é‡æ–°è¿æ¥...');
      
      // 5ç§’åå°è¯•é‡æ–°è¿æ¥
      setTimeout(connectWebSocket, 5000);
    };
    
    ws.onerror = function(error) {
      console.error('WebSocketé”™è¯¯:', error);
      showToast('WebSocketè¿æ¥é”™è¯¯');
    };
  }
  
  // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
  function handleMessage(data) {
    console.log('æ”¶åˆ°æ¶ˆæ¯:', data);
    
    switch (data.type) {
      case 'chat':
        // å¤„ç†èŠå¤©æ¶ˆæ¯
        handleChatMessage(data);
        break;
        
      case 'system':
        // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
        showSystemMessage(data.message);
        break;
        
      case 'user_join':
        // ç”¨æˆ·åŠ å…¥èŠå¤©å®¤
        showSystemMessage(`${data.nickname || data.username} åŠ å…¥äº†èŠå¤©`);
        break;
        
      case 'user_leave':
        // ç”¨æˆ·ç¦»å¼€èŠå¤©å®¤
        showSystemMessage(`${data.nickname || data.username} ç¦»å¼€äº†èŠå¤©`);
        break;
        
      case 'rooms_list':
        // æ›´æ–°èŠå¤©å®¤åˆ—è¡¨
        updateRoomsList(data.rooms);
        break;
        
      case 'users_list':
        // æ›´æ–°ç”¨æˆ·åˆ—è¡¨
        updateUsersList(data.users);
        break;
        
      case 'members_list':
        // æ›´æ–°æˆå‘˜åˆ—è¡¨
        updateMembersList(data.members);
        break;
        
      case 'typing':
        // æ˜¾ç¤ºç”¨æˆ·æ­£åœ¨è¾“å…¥
        showTypingIndicator(data);
        break;
        
      default:
        console.log('æœªçŸ¥æ¶ˆæ¯ç±»å‹:', data.type);
    }
  }
  
  // å¤„ç†èŠå¤©æ¶ˆæ¯
  function handleChatMessage(data) {
    // å­˜å‚¨æ¶ˆæ¯å†å²
    if (!messageHistory[data.sender_id]) {
      messageHistory[data.sender_id] = [];
    }
    messageHistory[data.sender_id].push(data);
    
    // å¦‚æœæ˜¯å½“å‰èŠå¤©ï¼Œç›´æ¥æ˜¾ç¤º
    if ((currentChatType === 'room' && data.room_id === currentRoomId) || 
        (currentChatType === 'private' && data.sender_id === currentChatId) || 
        (currentChatType === 'private' && data.receiver_id === currentChatId)) {
      appendChatMessage(data);
      scrollToBottom();
      
      // æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³
      if (localStorage.getItem('chat_sound_enabled') !== 'false') {
        playMessageSound(data.sender_id === userId);
      }
    } else {
      // å¢åŠ æœªè¯»æ¶ˆæ¯è®¡æ•°
      const chatId = data.room_id || data.sender_id;
      unreadMessages[chatId] = (unreadMessages[chatId] || 0) + 1;
      updateUnreadBadge(chatId);
      
      // æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³
      if (localStorage.getItem('chat_sound_enabled') !== 'false') {
        playMessageSound(false);
      }
    }
  }
  
  // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
  function appendChatMessage(data) {
    const isSelf = data.sender_id === userId;
    const senderName = isSelf ? 'ä½ ' : (data.nickname || data.username);
    const messageDate = new Date(data.timestamp);
    const formattedTime = messageDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    const showTimestamp = localStorage.getItem('chat_show_timestamp') !== 'false';
    
    let messageContent = '';
    
    if (data.message_type === 'text') {
      // æ–‡æœ¬æ¶ˆæ¯
      messageContent = `<div class="message-text">${formatMessage(data.message)}</div>`;
    } else if (data.message_type === 'image') {
      // å›¾ç‰‡æ¶ˆæ¯
      messageContent = `
        <div class="message-image-container">
          <img src="${data.message}" class="message-image" alt="å›¾ç‰‡æ¶ˆæ¯">
      </div>
      `;
    }
    
    const messageHtml = `
      <div class="message ${isSelf ? 'message-self' : ''}">
        ${!isSelf ? `<img src="${getUserAvatarUrl(data.username, data.nickname)}" class="message-avatar" alt="${senderName}">` : ''}
        <div class="message-content">
          <div class="message-header">
            <span class="message-sender">${senderName}</span>
            <span class="message-time" ${!showTimestamp ? 'style="display:none"' : ''}>${formattedTime}</span>
          </div>
          ${messageContent}
        </div>
        ${isSelf ? `<img src="${getUserAvatarUrl(username, nickname)}" class="message-avatar" alt="${senderName}">` : ''}
      </div>
    `;
    
    $('#chatWindow').append(messageHtml);
  }
  
  // æ ¼å¼åŒ–æ¶ˆæ¯æ–‡æœ¬ï¼ˆè½¬ä¹‰HTMLå¹¶æ·»åŠ è¡¨æƒ…å’Œé“¾æ¥ï¼‰
  function formatMessage(message) {
    // è½¬ä¹‰HTML
    let formatted = $('<div>').text(message).html();
    
    // å°†URLè½¬æ¢ä¸ºé“¾æ¥
    formatted = formatted.replace(
      /(https?:\/\/[^\s]+)/g, 
      '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>'
    );
    
    // å°†æ¢è¡Œç¬¦è½¬æ¢ä¸º<br>
    formatted = formatted.replace(/\n/g, '<br>');
    
    return formatted;
  }
  
  // æ˜¾ç¤ºç³»ç»Ÿæ¶ˆæ¯
  function showSystemMessage(message) {
    const systemMessageHtml = `
      <div class="system-message">
        <div class="system-message-content">${message}</div>
      </div>
    `;
    
    $('#chatWindow').append(systemMessageHtml);
    scrollToBottom();
  }
  
  // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥æç¤º
  function showTypingIndicator(data) {
    // å¦‚æœä¸æ˜¯å½“å‰èŠå¤©ï¼Œå¿½ç•¥
    if ((currentChatType === 'room' && data.room_id !== currentRoomId) || 
        (currentChatType === 'private' && data.sender_id !== currentChatId)) {
      return;
    }
    
    // ä¸æ˜¾ç¤ºè‡ªå·±çš„è¾“å…¥çŠ¶æ€
    if (data.sender_id === userId) {
      return;
    }
    
    if (data.isTyping) {
      // å¦‚æœè¾“å…¥æŒ‡ç¤ºå™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
      if ($('#typingIndicator').length === 0) {
        const indicatorHtml = `
          <div id="typingIndicator" class="typing-indicator">
            <span class="typing-name">${data.nickname || data.username}</span> æ­£åœ¨è¾“å…¥...
          </div>
        `;
        $('#chatWindow').append(indicatorHtml);
    scrollToBottom();
      } else {
        // æ›´æ–°æ­£åœ¨è¾“å…¥çš„ç”¨æˆ·åç§°
        $('#typingIndicator .typing-name').text(data.nickname || data.username);
      }
    } else {
      // ç§»é™¤è¾“å…¥æŒ‡ç¤ºå™¨
      $('#typingIndicator').remove();
    }
  }
  
  // å¤„ç†è¾“å…¥çŠ¶æ€
  function handleTypingStatus() {
    // å¦‚æœæ²¡æœ‰è¿æ¥æˆ–æ²¡æœ‰å½“å‰èŠå¤©ï¼Œä¸å‘é€çŠ¶æ€
    if (!isConnected || !currentChatId) {
      return;
    }
    
    // æ£€æŸ¥æœ€åä¸€æ¬¡è¾“å…¥æ—¶é—´
    const now = Date.now();
    if (!isTyping) {
      isTyping = true;
      sendTypingStatus(true);
    } else if (now - lastTypingTime > TYPING_TIMER_LENGTH) {
      // å¦‚æœä¸Šæ¬¡è¾“å…¥æ—¶é—´è¶…è¿‡3ç§’ï¼Œå†æ¬¡å‘é€è¾“å…¥çŠ¶æ€
      sendTypingStatus(true);
    }
    
    // æ›´æ–°æœ€åè¾“å…¥æ—¶é—´
    lastTypingTime = now;
    
    // æ¸…é™¤ä¹‹å‰çš„è¶…æ—¶è®¡æ—¶å™¨
    clearTimeout(typingTimeout);
    
    // è®¾ç½®æ–°çš„è¶…æ—¶è®¡æ—¶å™¨
    typingTimeout = setTimeout(function() {
      isTyping = false;
      sendTypingStatus(false);
    }, TYPING_TIMER_LENGTH);
  }
  
  // å‘é€è¾“å…¥çŠ¶æ€
  function sendTypingStatus(isTyping) {
    if (!isConnected) return;
    
    const message = {
      type: 'typing',
      isTyping: isTyping
    };
    
    if (currentChatType === 'room') {
      message.room_id = currentRoomId;
    } else {
      message.receiver_id = currentChatId;
    }
    
    ws.send(JSON.stringify(message));
  }
  
  // æ’­æ”¾æ¶ˆæ¯æç¤ºéŸ³
  function playMessageSound(isSelf) {
    const soundUrl = isSelf ? '/static/sounds/message-sent.mp3' : '/static/sounds/message-received.mp3';
    
    try {
      const audio = new Audio(soundUrl);
      audio.volume = 0.5;
      audio.play().catch(function(error) {
        console.log('æ— æ³•æ’­æ”¾æç¤ºéŸ³:', error);
      });
    } catch (error) {
      console.log('ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾:', error);
    }
  }
  
  // æ»šåŠ¨åˆ°åº•éƒ¨
  function scrollToBottom() {
    const chatWindow = document.getElementById('chatWindow');
    chatWindow.scrollTop = chatWindow.scrollHeight;
  }
  
  // ===== æ¶ˆæ¯å‘é€å’ŒèŠå¤©å®¤æ“ä½œ =====
  
  // å‘é€æ¶ˆæ¯
  function sendMessage() {
    // è·å–æ¶ˆæ¯å†…å®¹
    const messageInput = $('#messageInput');
    const message = messageInput.val().trim();
    
    // ç©ºæ¶ˆæ¯ä¸å‘é€
    if (message === '' || !isConnected || !currentChatId) {
      return;
    }
    
    // æ„å»ºæ¶ˆæ¯å¯¹è±¡
    const messageObj = {
      type: 'chat',
      message_type: 'text',
      message: message
    };
    
    // æ ¹æ®èŠå¤©ç±»å‹è®¾ç½®æ¥æ”¶è€…
    if (currentChatType === 'room') {
      messageObj.room_id = currentRoomId;
    } else {
      messageObj.receiver_id = currentChatId;
    }
    
    // å‘é€æ¶ˆæ¯
    ws.send(JSON.stringify(messageObj));
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    messageInput.val('');
    messageInput.trigger('input');
    
    // é‡ç½®è¾“å…¥çŠ¶æ€
    isTyping = false;
    clearTimeout(typingTimeout);
    sendTypingStatus(false);
    
    // èšç„¦åˆ°è¾“å…¥æ¡†
    messageInput.focus();
  }
  
  // ä¸Šä¼ å›¾ç‰‡
  function uploadImage(file) {
    // æ£€æŸ¥æ–‡ä»¶ç±»å‹
    if (!file.type.match('image.*')) {
      showToast('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
      return;
    }
    
    // æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæœ€å¤§5MBï¼‰
    if (file.size > 5 * 1024 * 1024) {
      showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡5MB');
      return;
    }
    
    // åˆ›å»ºFormDataå¯¹è±¡
    const formData = new FormData();
    formData.append('image', file);
    
    // æ˜¾ç¤ºä¸Šä¼ ä¸­æç¤º
    showToast('æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...');
    
    // å‘èµ·ä¸Šä¼ è¯·æ±‚,axios
    axios.post('/api/chat/upload_image', formData, {
      headers: {
        'Content-Type': 'multipart/form-data'
      }
    }).then(function (response) {
      // å‘é€å›¾ç‰‡æ¶ˆæ¯
      const messageObj = {
        type: 'chat',
        message_type: 'image',
        message: response.data.image_url
      };
      
      // æ ¹æ®èŠå¤©ç±»å‹è®¾ç½®æ¥æ”¶è€…
      if (currentChatType === 'room') {
        messageObj.room_id = currentRoomId;
      } else {
        messageObj.receiver_id = currentChatId;
      }
      
      // å‘é€æ¶ˆæ¯
      ws.send(JSON.stringify(messageObj));
    }).catch(function (error) {
      showToast('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + (error.responseJSON?.message || error));
    });
  }
  
  // è·å–èŠå¤©å®¤åˆ—è¡¨
  function fetchChatRooms() {
    axios.get('/api/chat/rooms').then(function (response) {
      updateRoomsList(response.data.rooms);
    }).catch(function (error) {
      showToast('è·å–èŠå¤©å®¤åˆ—è¡¨å¤±è´¥ï¼š' + (error.responseJSON?.message || error));
    });
  }
  
  // åˆ›å»ºèŠå¤©å®¤
  function createChatRoom() {
    const roomName = $('#roomName').val().trim();
    const roomDescription = $('#roomDescription').val().trim();
    const isPrivate = $('#roomIsPrivate').is(':checked');
    
    if (roomName === '') {
      showToast('è¯·è¾“å…¥èŠå¤©å®¤åç§°');
      return;
    }
    
    const roomData = {
      name: roomName,
      description: roomDescription,
      is_private: isPrivate
    };
    
    axios.post('/api/chat/rooms', roomData).then(function (response) {
        showToast('èŠå¤©å®¤åˆ›å»ºæˆåŠŸ');
        $('#createRoomModal').modal('hide');
        
        // æ¸…ç©ºè¡¨å•
        $('#roomName').val('');
        $('#roomDescription').val('');
        $('#roomIsPrivate').prop('checked', false);
        
        // åˆ·æ–°èŠå¤©å®¤åˆ—è¡¨
        fetchChatRooms();
        
        // æ‰“å¼€æ–°åˆ›å»ºçš„èŠå¤©å®¤
        openChat('room', response.room.id);
      }).catch(function (error) {
        showToast('åˆ›å»ºèŠå¤©å®¤å¤±è´¥ï¼š' + (error.responseJSON?.message || error));
      });
  }
  
  // åŠ å…¥èŠå¤©å®¤
  function joinRoom(roomId) {
    if (!isConnected) return;
    
    ws.send(JSON.stringify({
      type: 'join_room',
      room_id: roomId
    }));
  }
  
  // ç¦»å¼€èŠå¤©å®¤
  function leaveRoom(roomId) {
    if (!isConnected) return;
    
    ws.send(JSON.stringify({
      type: 'leave_room',
      room_id: roomId
    }));
  }
  
  // è·å–èŠå¤©å®¤æˆå‘˜
  function fetchRoomMembers(roomId) {
    if (!isConnected) return;
    
    ws.send(JSON.stringify({
      type: 'get_members',
      room_id: roomId
    }));
  }
</script>
{% endblock %}