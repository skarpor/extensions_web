<template>
  <div class="modern-extension-view" :class="themeClass">
    <!-- È°∂ÈÉ®ÂØºËà™Ê†è -->
    <div class="top-navbar">
      <div class="navbar-content">
        <div class="navbar-left">
          <h1 class="page-title">
            <el-icon><Operation /></el-icon>
            Êâ©Â±ïÂ∑•‰ΩúÂè∞
          </h1>
          <span class="page-subtitle">Áé∞‰ª£ÂåñÊâ©Â±ïÊâßË°åÁéØÂ¢É</span>
        </div>
        
        <div class="navbar-right">
          <el-button-group>
            <el-button @click="refreshExtensions" :loading="loading" size="small">
              <el-icon><Refresh /></el-icon>
              Âà∑Êñ∞
            </el-button>
            <el-button @click="showSettings = true" size="small">
              <el-icon><Tools /></el-icon>
              ËÆæÁΩÆ
            </el-button>
          </el-button-group>
        </div>
      </div>
    </div>

    <!-- ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü -->
    <div class="main-content">
      <!-- ‰æßËæπÊ†è -->
      <div class="sidebar" :style="sidebarStyle">
        <div class="sidebar-header">
          <h3>ÂèØÁî®Êâ©Â±ï</h3>
          <el-tag :type="extensions.length > 0 ? 'success' : 'info'" size="small">
            {{ extensions.length }} ‰∏™
          </el-tag>
        </div>
        
        <div class="extension-list">
          <div 
            v-for="ext in extensions" 
            :key="ext.id"
            class="extension-item"
            :class="{ active: selectedExtension?.id === ext.id }"
            @click="selectExtension(ext)"
          >
            <div class="extension-icon">
              <el-icon>
                <component :is="getExtensionIcon(ext.render_type)" />
              </el-icon>
            </div>
            
            <div class="extension-info">
              <div class="extension-name">{{ ext.name }}</div>
              <div class="extension-type">{{ getTypeLabel(ext.render_type) }}</div>
            </div>
            
            <div class="extension-status">
              <el-tag 
                :type="ext.enabled ? 'success' : 'danger'" 
                size="small"
                effect="plain"
              >
                {{ ext.enabled ? 'ÂêØÁî®' : 'Á¶ÅÁî®' }}
              </el-tag>
            </div>
          </div>
        </div>
      </div>

      <!-- Â∑•‰ΩúÂå∫Âüü -->
      <div class="workspace">
        <!-- Êâ©Â±ïÊú™ÈÄâÊã©Áä∂ÊÄÅ -->
        <div v-if="!selectedExtension" class="empty-state">
          <el-empty description="ËØ∑‰ªéÂ∑¶‰æßÈÄâÊã©‰∏Ä‰∏™Êâ©Â±ïÂºÄÂßã‰ΩøÁî®">
            <template #image>
              <el-icon size="100" color="#409eff"><Operation /></el-icon>
            </template>
          </el-empty>
        </div>

        <!-- Êâ©Â±ïËØ¶ÊÉÖÂíåÊâßË°åÂå∫Âüü -->
        <div v-else class="extension-workspace">
          <!-- Êâ©Â±ï‰ø°ÊÅØÂç°Áâá -->
          <el-card class="extension-info-card" shadow="never">
            <template #header>
              <div class="card-header">
                <div class="extension-title">
                  <el-icon size="24">
                    <component :is="getExtensionIcon(selectedExtension.render_type)" />
                  </el-icon>
                  <div>
                    <h2>{{ selectedExtension.name }}</h2>
                    <p class="extension-description">{{ selectedExtension.description || 'ÊöÇÊó†ÊèèËø∞' }}</p>
                  </div>
                </div>
                
                <div class="extension-meta">
                  <el-tag :type="getTypeColor(selectedExtension.render_type)" effect="light">
                    {{ getTypeLabel(selectedExtension.render_type) }}
                  </el-tag>
                  <el-tag type="info" effect="plain" size="small">
                    {{ selectedExtension.endpoint }}
                  </el-tag>
                </div>
              </div>
            </template>

            <!-- Êü•ËØ¢Ë°®ÂçïÂå∫Âüü -->
            <div class="query-section">
              <div class="section-header">
                <h3>
                  <el-icon><Edit /></el-icon>
                  Êü•ËØ¢ÂèÇÊï∞
                </h3>
                <el-button 
                  type="primary" 
                  @click="executeExtension"
                  :loading="executing"
                  :disabled="!selectedExtension.enabled"
                >
                  <el-icon><CaretRight /></el-icon>
                  ÊâßË°åÊü•ËØ¢
                </el-button>
              </div>

              <div class="query-form-container">
                <div v-if="loadingForm" class="loading-state">
                  <el-skeleton :rows="3" animated />
                </div>
                
                <div v-else-if="formError" class="error-state">
                  <el-alert type="error" :title="formError" show-icon />
                </div>
                
                <div v-else-if="selectedExtension.has_query_form" class="dynamic-form">
                  <div class="form-debug" v-if="queryFormHtml">
                    <small style="color: #6c757d;">Ë°®ÂçïHTMLÈïøÂ∫¶: {{ queryFormHtml.length }} Â≠óÁ¨¶</small>
                  </div>
                  <form class="form-content" @submit.prevent="executeExtension">
                    <div v-html="queryFormHtml"></div>
                  </form>
                </div>
                
                <div v-else class="no-params">
                  <el-empty description="Ê≠§Êâ©Â±ïÊó†ÈúÄÈ¢ùÂ§ñÂèÇÊï∞" :image-size="80">
                    <template #image>
                      <el-icon size="80" color="#909399"><Check /></el-icon>
                    </template>
                  </el-empty>
                </div>
              </div>
            </div>
          </el-card>

          <!-- ÁªìÊûúÊòæÁ§∫Âå∫Âüü -->
          <div v-if="hasResult" class="result-section">
            <el-card shadow="never">
              <template #header>
                <div class="result-header">
                  <div class="result-title">
                    <el-icon><DataAnalysis /></el-icon>
                    <span>ÊâßË°åÁªìÊûú</span>
                    <el-tag :type="getResultStatusType()" size="small">
                      {{ getResultStatusText() }}
                    </el-tag>
                    <el-tag v-if="isAutoExecuting" type="warning" size="small" effect="plain">
                      <el-icon><Refresh /></el-icon>
                      Ëá™Âä®ÊâßË°å‰∏≠
                    </el-tag>
                    <el-tag v-else-if="workspaceSettings.autoReExecute && selectedExtension" type="success" size="small" effect="plain">
                      <el-icon><Timer /></el-icon>
                      Ëá™Âä®ÊâßË°åÂ∑≤ÂêØÁî®
                    </el-tag>
                  </div>
                  
                  <div class="result-actions">
                    <el-button-group size="small">
                      <el-button @click="copyResult" v-if="canCopyResult">
                        <el-icon><DocumentCopy /></el-icon>
                        Â§çÂà∂
                      </el-button>
                      <el-button @click="downloadResult" v-if="canDownloadResult">
                        <el-icon><Download /></el-icon>
                        ‰∏ãËΩΩ
                      </el-button>
                      <el-button @click="clearResult">
                        <el-icon><Delete /></el-icon>
                        Ê∏ÖÈô§
                      </el-button>
                      <el-button @click="toggleResultPopup" type="primary">
                        <el-icon><FullScreen /></el-icon>
                        ÂºπÂá∫ÊòæÁ§∫
                      </el-button>
                    </el-button-group>
                  </div>
                </div>
              </template>

              <!-- ÁªìÊûúÂÜÖÂÆπ -->
              <div class="result-content" :style="resultContentStyle">
                <!-- ÊâßË°å‰∏≠Áä∂ÊÄÅ -->
                <div v-if="executing" class="executing-state">
                  <div class="execution-progress">
                    <el-progress 
                      :percentage="executionProgress" 
                      :status="executionProgress === 100 ? 'success' : null"
                      :stroke-width="8"
                    />
                    <p class="progress-text">{{ executionText }}</p>
                  </div>
                </div>

                <!-- ÈîôËØØÁä∂ÊÄÅ -->
                <div v-else-if="executionError" class="error-result">
                  <el-alert 
                    type="error" 
                    :title="executionError" 
                    show-icon 
                    :closable="false"
                  />
                </div>

                <!-- ÊàêÂäüÁªìÊûú -->
                <div v-else class="success-result">
                  <!-- HTMLÁªìÊûú -->
                  <div v-if="resultType === 'html'" class="html-result">
                    <div v-html="resultData" class="html-content"></div>
                  </div>

                  <!-- Ë°®Ê†ºÁªìÊûú -->
                  <div v-else-if="resultType === 'table'" class="table-result">
                    <div class="table-header">
                      <h4>üìä Ë°®Ê†ºÊï∞ÊçÆ</h4>
                      <div class="table-meta">
                        <el-tag type="info" size="small">{{ getTableRowCount() }} Êù°ËÆ∞ÂΩï</el-tag>
                        <el-tag v-if="resultMeta?.Êü•ËØ¢Êó∂Èó¥" type="success" size="small">
                          {{ resultMeta.Êü•ËØ¢Êó∂Èó¥ }}
                        </el-tag>
                      </div>
                      <div class="table-actions">
                        <el-button-group size="small">
                          <el-button @click="exportTableData('csv')">
                            <el-icon><Document /></el-icon>
                            CSV
                          </el-button>
                          <el-button @click="exportTableData('json')">
                            <el-icon><Folder /></el-icon>
                            JSON
                          </el-button>
                          <el-button @click="toggleTableFullscreen">
                            <el-icon><FullScreen /></el-icon>
                            ÂÖ®Â±è
                          </el-button>
                        </el-button-group>
                      </div>
                    </div>
                    <div class="table-container" :class="{ fullscreen: tableFullscreen }">
                      <el-table
                        :data="paginatedTableData"
                        border
                        stripe
                        :height="tableFullscreen ? '70vh' : '400px'"
                        @sort-change="handleTableSort"
                      >
                        <el-table-column
                          v-for="column in tableColumns"
                          :key="column.prop"
                          :prop="column.prop"
                          :label="column.label"
                          :sortable="column.sortable"
                          :width="column.width"
                          show-overflow-tooltip
                        >
                          <template #default="scope">
                            <span v-if="column.type === 'number'" class="number-cell">
                              {{ formatNumber(scope.row[column.prop]) }}
                            </span>
                            <el-tag
                              v-else-if="column.type === 'status'"
                              :type="getStatusType(scope.row[column.prop])"
                              size="small"
                            >
                              {{ scope.row[column.prop] }}
                            </el-tag>
                            <span v-else>{{ scope.row[column.prop] }}</span>
                          </template>
                        </el-table-column>
                      </el-table>

                      <!-- ÂàÜÈ°µÂô® -->
                      <div v-if="getTableRowCount() > tablePageSize" class="table-pagination">
                        <el-pagination
                          v-model:current-page="tableCurrentPage"
                          v-model:page-size="tablePageSize"
                          :page-sizes="[10, 20, 50, 100]"
                          :total="getTableRowCount()"
                          layout="total, sizes, prev, pager, next, jumper"
                          @size-change="handleTableSizeChange"
                          @current-change="handleTableCurrentChange"
                        />
                      </div>
                    </div>
                  </div>

                  <!-- ÂõæÁâáÁªìÊûú -->
                  <div v-else-if="resultType === 'image'" class="image-result">
                    <div class="image-header">
                      <h4>üñºÔ∏è ÂõæÁâáÁªìÊûú</h4>
                    </div>
                    <div class="image-container">
                      <img :src="resultData" alt="Êâ©Â±ïÁîüÊàêÁöÑÂõæÁâá" style="max-width: 100%; height: auto;" />
                    </div>
                  </div>

                  <!-- Êñá‰ª∂ÁªìÊûú -->
                  <div v-else-if="resultType === 'file'" class="file-result">
                    <div class="file-header">
                      <h4>üìÅ Êñá‰ª∂ÁªìÊûú</h4>
                    </div>
                    <div class="file-info">
                      <p><strong>Êñá‰ª∂Âêç:</strong> {{ resultData?.filename || 'Êú™Áü•Êñá‰ª∂' }}</p>
                      <p><strong>Á±ªÂûã:</strong> {{ resultData?.content_type || 'Êú™Áü•Á±ªÂûã' }}</p>
                      <el-button type="primary" @click="handleFileDownload">
                        <el-icon><Download /></el-icon>
                        ‰∏ãËΩΩÊñá‰ª∂
                      </el-button>
                    </div>
                  </div>

                  <!-- ÂõæË°®ÁªìÊûú -->
                  <div v-else-if="resultType === 'chart'" class="chart-result">
                    <div class="chart-header">
                      <h4>üìà ÂõæË°®ÁªìÊûú</h4>
                      <el-tag type="success" size="small">{{ resultData?.chart_type || 'ÂõæË°®' }}</el-tag>
                      <div class="chart-actions">
                        <el-button-group size="small">
                          <el-button @click="exportChart('png')">
                            <el-icon><Picture /></el-icon>
                            PNG
                          </el-button>
                          <el-button @click="toggleChartFullscreen">
                            <el-icon><FullScreen /></el-icon>
                            ÂÖ®Â±è
                          </el-button>
                          <el-button @click="showChartData = !showChartData">
                            <el-icon><Grid /></el-icon>
                            Êï∞ÊçÆ
                          </el-button>
                        </el-button-group>
                      </div>
                    </div>
                    <div class="chart-container">
                      <canvas ref="chartCanvas" :style="chartCanvasStyle"></canvas>
                      <div v-if="chartLoading" class="chart-loading">
                        <el-icon class="loading-icon"><Loading /></el-icon>
                        <p>ÂõæË°®Ê∏≤Êüì‰∏≠...</p>
                      </div>
                      <div v-if="chartError" class="chart-error">
                        <el-icon class="error-icon"><WarningFilled /></el-icon>
                        <p>{{ chartError }}</p>
                        <el-button @click="retryChart" size="small">ÈáçËØï</el-button>
                      </div>
                    </div>

                    <!-- ÂõæË°®Êï∞ÊçÆË°®Ê†º -->
                    <div v-if="showChartData && chartTableData.length > 0" class="chart-data-table">
                      <div class="table-header">
                        <h5>üìä ÂõæË°®Êï∞ÊçÆ</h5>
                        <el-button @click="showChartData = false" size="small">
                          <el-icon><Close /></el-icon>
                          ÂÖ≥Èó≠
                        </el-button>
                      </div>
                      <el-table :data="chartTableData" border stripe max-height="300">
                        <el-table-column
                          v-for="column in chartTableColumns"
                          :key="column.prop"
                          :prop="column.prop"
                          :label="column.label"
                          show-overflow-tooltip
                        />
                      </el-table>
                    </div>
                  </div>

                  <!-- ÊñáÊú¨ÁªìÊûú -->
                  <div v-else-if="resultType === 'text'" class="text-result">
                    <div class="text-header">
                      <h4>üìù ÊñáÊú¨ÁªìÊûú</h4>
                      <el-button @click="copyText" size="small">
                        <el-icon><DocumentCopy /></el-icon>
                        Â§çÂà∂
                      </el-button>
                    </div>
                    <div class="text-content">
                      <pre>{{ resultData }}</pre>
                    </div>
                  </div>

                  <!-- Êú™Áü•Á±ªÂûã -->
                  <div v-else class="unknown-result">
                    <el-alert
                      type="warning"
                      title="Êú™Áü•ÁöÑÁªìÊûúÁ±ªÂûã"
                      :description="`Á±ªÂûã: ${resultType}`"
                      show-icon
                    />
                    <pre class="raw-result">{{ resultData }}</pre>
                  </div>
                </div>
              </div>
            </el-card>
          </div>
        </div>
      </div>
    </div>

    <!-- ËÆæÁΩÆÂØπËØùÊ°Ü -->
    <el-dialog v-model="showSettings" title="Êâ©Â±ïÂ∑•‰ΩúÂè∞ËÆæÁΩÆ" width="800px">
      <el-form :model="workspaceSettings" label-width="150px">
        <el-form-item label="Ëá™Âä®Âà∑Êñ∞Êâ©Â±ïÂàóË°®">
          <el-switch v-model="workspaceSettings.autoRefreshExtensions" />
          <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
            ÂÆöÊúüÂà∑Êñ∞Êâ©Â±ïÂàóË°®ÔºåËé∑ÂèñÊúÄÊñ∞ÁöÑÊâ©Â±ïÁä∂ÊÄÅ
          </div>
        </el-form-item>
        <el-form-item label="Êâ©Â±ïÂàóË°®Âà∑Êñ∞Èó¥Èöî" v-if="workspaceSettings.autoRefreshExtensions">
          <el-input-number v-model="workspaceSettings.extensionRefreshInterval" :min="30" :max="600" />
          <span style="margin-left: 8px; color: #6c757d;">Áßí</span>
        </el-form-item>
        <el-form-item label="Ëá™Âä®ÈáçÊñ∞ÊâßË°å">
          <el-switch v-model="workspaceSettings.autoReExecute" />
          <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
            ÂÆöÊúüÈáçÊñ∞ÊâßË°åÂΩìÂâçÈÄâ‰∏≠ÁöÑÊâ©Â±ïÔºåËé∑ÂèñÊúÄÊñ∞ÁªìÊûú
          </div>
        </el-form-item>
        <el-form-item label="ÈáçÊñ∞ÊâßË°åÈó¥Èöî" v-if="workspaceSettings.autoReExecute">
          <el-input-number v-model="workspaceSettings.reExecuteInterval" :min="10" :max="300" />
          <span style="margin-left: 8px; color: #6c757d;">Áßí</span>
          <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
            ‰ΩøÁî®ÂΩìÂâçÈ°µÈù¢‰∏≠ÁöÑÊü•ËØ¢Ë°®ÂçïÊï∞ÊçÆËøõË°åËá™Âä®ÊâßË°å
          </div>
        </el-form-item>
        <el-form-item label="‰æßËæπÊ†èÂÆΩÂ∫¶">
          <el-slider v-model="workspaceSettings.sidebarWidth" :min="250" :max="500" />
        </el-form-item>
        <el-form-item label="ÁªìÊûúÂå∫ÂüüÈ´òÂ∫¶">
          <el-slider v-model="workspaceSettings.resultAreaHeight" :min="300" :max="800" />
        </el-form-item>
        <el-form-item label="‰∏ªÈ¢òÊ®°Âºè">
          <el-radio-group v-model="workspaceSettings.themeMode">
            <el-radio label="light">ÊµÖËâ≤</el-radio>
            <el-radio label="dark">Ê∑±Ëâ≤</el-radio>
            <el-radio label="auto">Ëá™Âä®</el-radio>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="ÁªìÊûúÊòæÁ§∫">
          <el-radio-group v-model="workspaceSettings.defaultResultDisplay">
            <el-radio label="inline">ÂÜÖÂµåÊòæÁ§∫</el-radio>
            <el-radio label="popup">ÂºπÂá∫ÊòæÁ§∫</el-radio>
            <el-radio label="auto">Ëá™Âä®ÈÄâÊã©</el-radio>
          </el-radio-group>
          <div style="font-size: 12px; color: #6c757d; margin-top: 4px;">
            Ëá™Âä®ÈÄâÊã©ÔºöÂ∞èÁªìÊûúÂÜÖÂµåÊòæÁ§∫ÔºåÂ§ßÁªìÊûúÂºπÂá∫ÊòæÁ§∫
          </div>
        </el-form-item>
      </el-form>
      <template #footer>
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <div style="font-size: 12px; color: #6c757d;">
            <div v-if="workspaceSettings.autoRefreshExtensions">
              üîÑ Êâ©Â±ïÂàóË°®Ëá™Âä®Âà∑Êñ∞: ÊØè{{ workspaceSettings.extensionRefreshInterval }}Áßí
            </div>
            <div v-if="workspaceSettings.autoReExecute">
              ‚ö° Ëá™Âä®ÈáçÊñ∞ÊâßË°å: ÊØè{{ workspaceSettings.reExecuteInterval }}Áßí
            </div>
            <div v-if="!workspaceSettings.autoRefreshExtensions && !workspaceSettings.autoReExecute">
              üí§ Êú™ÂêØÁî®Ëá™Âä®ÂäüËÉΩ
            </div>
          </div>
          <div>
            <el-button @click="showSettings = false">ÂèñÊ∂à</el-button>
            <el-button type="primary" @click="saveSettings(workspaceSettings)">‰øùÂ≠ò</el-button>
          </div>
        </div>
      </template>
    </el-dialog>

    <!-- ÁªìÊûúÂºπÂá∫ÊòæÁ§∫ÂØπËØùÊ°Ü -->
    <el-dialog
      v-model="resultPopupVisible"
      :title="getPopupTitle()"
      width="90%"
      :fullscreen="false"
      :close-on-click-modal="false"
      class="result-popup-dialog"
      top="5vh"
    >
      <div class="popup-result-container">
        <!-- ÂºπÂá∫Á™óÂè£Â∑•ÂÖ∑Ê†è -->
        <div class="popup-toolbar">
          <div class="popup-toolbar-left">
            <el-tag :type="getResultStatusType()" size="small">
              {{ getResultStatusText() }}
            </el-tag>
            <el-tag v-if="resultMeta?.generated_at" type="info" size="small">
              {{ resultMeta.generated_at }}
            </el-tag>
          </div>
          <div class="popup-toolbar-right">
            <el-button-group size="small">
              <el-button @click="copyResult" v-if="canCopyResult">
                <el-icon><DocumentCopy /></el-icon>
                Â§çÂà∂
              </el-button>
              <el-button @click="downloadResult" v-if="canDownloadResult">
                <el-icon><Download /></el-icon>
                ‰∏ãËΩΩ
              </el-button>
              <el-button @click="toggleResultPopup">
                <el-icon><Close /></el-icon>
                ÂÖ≥Èó≠
              </el-button>
            </el-button-group>
          </div>
        </div>

        <!-- ÂºπÂá∫Á™óÂè£ÂÜÖÂÆπ -->
        <div class="popup-content">
          <!-- HTMLÁªìÊûú -->
          <div v-if="resultType === 'html'" class="popup-html-result">
            <div v-html="resultData" class="popup-html-content"></div>
          </div>

          <!-- Ë°®Ê†ºÁªìÊûú -->
          <div v-else-if="resultType === 'table'" class="popup-table-result">
            <div class="popup-table-header">
              <div class="table-meta">
                <el-tag type="info" size="small">{{ getTableRowCount() }} Êù°ËÆ∞ÂΩï</el-tag>
                <el-tag v-if="resultMeta?.Êü•ËØ¢Êó∂Èó¥" type="success" size="small">
                  {{ resultMeta.Êü•ËØ¢Êó∂Èó¥ }}
                </el-tag>
              </div>
              <div class="table-actions">
                <el-button-group size="small">
                  <el-button @click="exportTableData('csv')">
                    <el-icon><Document /></el-icon>
                    CSV
                  </el-button>
                  <el-button @click="exportTableData('json')">
                    <el-icon><Folder /></el-icon>
                    JSON
                  </el-button>
                </el-button-group>
              </div>
            </div>
            <el-table
              :data="paginatedTableData"
              border
              stripe
              height="60vh"
              @sort-change="handleTableSort"
            >
              <el-table-column
                v-for="column in tableColumns"
                :key="column.prop"
                :prop="column.prop"
                :label="column.label"
                :sortable="column.sortable"
                :width="column.width"
                show-overflow-tooltip
              >
                <template #default="scope">
                  <span v-if="column.type === 'number'" class="number-cell">
                    {{ formatNumber(scope.row[column.prop]) }}
                  </span>
                  <el-tag
                    v-else-if="column.type === 'status'"
                    :type="getStatusType(scope.row[column.prop])"
                    size="small"
                  >
                    {{ scope.row[column.prop] }}
                  </el-tag>
                  <span v-else>{{ scope.row[column.prop] }}</span>
                </template>
              </el-table-column>
            </el-table>

            <!-- ÂàÜÈ°µÂô® -->
            <div v-if="getTableRowCount() > tablePageSize" class="popup-table-pagination">
              <el-pagination
                v-model:current-page="tableCurrentPage"
                v-model:page-size="tablePageSize"
                :page-sizes="[10, 20, 50, 100]"
                :total="getTableRowCount()"
                layout="total, sizes, prev, pager, next, jumper"
                @size-change="handleTableSizeChange"
                @current-change="handleTableCurrentChange"
              />
            </div>
          </div>

          <!-- ÂõæË°®ÁªìÊûú -->
          <div v-else-if="resultType === 'chart'" class="popup-chart-result">
            <div class="popup-chart-container">
              <canvas ref="popupChartCanvas" style="width: 100%; height: 60vh;"></canvas>
              <div v-if="chartLoading" class="chart-loading">
                <el-icon class="loading-icon"><Loading /></el-icon>
                <p>ÂõæË°®Ê∏≤Êüì‰∏≠...</p>
              </div>
              <div v-if="chartError" class="chart-error">
                <el-icon class="error-icon"><WarningFilled /></el-icon>
                <p>{{ chartError }}</p>
                <el-button @click="retryPopupChart" size="small">ÈáçËØï</el-button>
              </div>
            </div>

            <!-- ÂõæË°®Êìç‰ΩúÊåâÈíÆ -->
            <div class="popup-chart-actions">
              <el-button-group size="small">
                <el-button @click="exportPopupChart('png')">
                  <el-icon><Picture /></el-icon>
                  ÂØºÂá∫PNG
                </el-button>
                <el-button @click="showChartData = !showChartData">
                  <el-icon><Grid /></el-icon>
                  {{ showChartData ? 'ÈöêËóèÊï∞ÊçÆ' : 'ÊòæÁ§∫Êï∞ÊçÆ' }}
                </el-button>
              </el-button-group>
            </div>

            <!-- ÂõæË°®Êï∞ÊçÆË°®Ê†º -->
            <div v-if="showChartData && chartTableData.length > 0" class="popup-chart-data">
              <el-table :data="chartTableData" border stripe max-height="300">
                <el-table-column
                  v-for="column in chartTableColumns"
                  :key="column.prop"
                  :prop="column.prop"
                  :label="column.label"
                  show-overflow-tooltip
                />
              </el-table>
            </div>
          </div>

          <!-- ÊñáÊú¨ÁªìÊûú -->
          <div v-else-if="resultType === 'text'" class="popup-text-result">
            <div class="popup-text-header">
              <div class="text-stats">
                <el-tag type="info" size="small">
                  {{ resultData?.length || 0 }} Â≠óÁ¨¶
                </el-tag>
                <el-tag type="success" size="small">
                  {{ (resultData || '').split('\n').length }} Ë°å
                </el-tag>
              </div>
              <div class="text-actions">
                <el-button @click="copyText" size="small">
                  <el-icon><DocumentCopy /></el-icon>
                  Â§çÂà∂ÂÖ®Êñá
                </el-button>
              </div>
            </div>
            <div class="popup-text-content">
              <pre>{{ resultData }}</pre>
            </div>
          </div>

          <!-- ÂõæÁâáÁªìÊûú -->
          <div v-else-if="resultType === 'image'" class="popup-image-result">
            <div class="popup-image-container">
              <img :src="resultData" alt="Êâ©Â±ïÁîüÊàêÁöÑÂõæÁâá" class="popup-image" />
            </div>
          </div>

          <!-- Êñá‰ª∂ÁªìÊûú -->
          <div v-else-if="resultType === 'file'" class="popup-file-result">
            <div class="popup-file-info">
              <div class="file-icon">
                <el-icon size="48"><Folder /></el-icon>
              </div>
              <div class="file-details">
                <h3>{{ resultData?.filename || '‰∏ãËΩΩÊñá‰ª∂' }}</h3>
                <p>Á±ªÂûã: {{ resultData?.content_type || 'Êú™Áü•Á±ªÂûã' }}</p>
                <p v-if="resultData?.size">Â§ßÂ∞è: {{ formatFileSize(resultData.size) }}</p>
              </div>
              <div class="file-actions">
                <el-button type="primary" @click="handleFileDownload" size="large">
                  <el-icon><Download /></el-icon>
                  ‰∏ãËΩΩÊñá‰ª∂
                </el-button>
              </div>
            </div>
          </div>

          <!-- Êú™Áü•Á±ªÂûã -->
          <div v-else class="popup-unknown-result">
            <el-alert
              type="warning"
              title="Êú™Áü•ÁöÑÁªìÊûúÁ±ªÂûã"
              :description="`Á±ªÂûã: ${resultType}`"
              show-icon
            />
            <pre class="popup-raw-result">{{ resultData }}</pre>
          </div>
        </div>
      </div>
    </el-dialog>
  </div>
</template>

<script>
import { ref, reactive, computed, onMounted, onUnmounted, nextTick } from 'vue'
import { ElMessage, ElMessageBox } from 'element-plus'
import {
  Operation,
  Refresh,
  Tools,
  Edit,
  CaretRight,
  Check,
  DataAnalysis,
  DocumentCopy,
  Download,
  Delete,
  Document,
  Grid,
  Picture,
  Folder,
  PieChart,
  Memo,
  Timer,
  FullScreen,
  Loading,
  WarningFilled,
  Close
} from '@element-plus/icons-vue'

// ÂØºÂÖ•ÁªìÊûúÊòæÁ§∫ÁªÑ‰ª∂ÔºàÊöÇÊó∂Ê≥®ÈáäÊéâ‰∏çÂ≠òÂú®ÁöÑÁªÑ‰ª∂Ôºâ
// import TableResultDisplay from './components/TableResultDisplay.vue'
// import ImageResultDisplay from './components/ImageResultDisplay.vue'
// import FileResultDisplay from './components/FileResultDisplay.vue'
// import ChartResultDisplay from './components/ChartResultDisplay.vue'
// import TextResultDisplay from './components/TextResultDisplay.vue'
// import WorkspaceSettings from './components/WorkspaceSettings.vue'

// ÂØºÂÖ•API
import { getExtensions, getExtensionQueryForm, executeExtensionQuery } from '@/api/extension'

export default {
  name: 'ModernExtensionView',
  components: {
    // Element Plus ÂõæÊ†áÁªÑ‰ª∂
    Operation,
    Refresh,
    Tools,
    Edit,
    CaretRight,
    Check,
    DataAnalysis,
    DocumentCopy,
    Download,
    Delete,
    Document,
    Grid,
    Picture,
    Folder,
    PieChart,
    Memo,
    Timer,
    FullScreen,
    Loading,
    WarningFilled,
    Close,
    // ÊöÇÊó∂Ê≥®ÈáäÊéâ‰∏çÂ≠òÂú®ÁöÑÁªÑ‰ª∂
    // TableResultDisplay,
    // ImageResultDisplay,
    // FileResultDisplay,
    // ChartResultDisplay,
    // TextResultDisplay,
    // WorkspaceSettings
  },
  setup() {
    // ÂìçÂ∫îÂºèÊï∞ÊçÆ
    const extensions = ref([])
    const selectedExtension = ref(null)
    const loading = ref(false)
    const loadingForm = ref(false)
    const executing = ref(false)
    const executionProgress = ref(0)
    const executionText = ref('')
    const isAutoExecuting = ref(false)
    
    // Ë°®ÂçïÁõ∏ÂÖ≥
    const queryFormHtml = ref('')
    const formError = ref('')
    
    // ÁªìÊûúÁõ∏ÂÖ≥
    const resultType = ref('')
    const resultData = ref(null)
    const resultMeta = ref(null)
    const executionError = ref('')

    // ÂõæË°®Áõ∏ÂÖ≥
    const chartCanvas = ref(null)
    const chartInstance = ref(null)
    const chartLoading = ref(false)
    const chartError = ref('')
    const showChartData = ref(false)
    const chartFullscreen = ref(false)

    // Ë°®Ê†ºÁõ∏ÂÖ≥
    const tableCurrentPage = ref(1)
    const tablePageSize = ref(20)
    const tableSortConfig = ref({ prop: '', order: '' })
    const tableFullscreen = ref(false)

    // ÁªìÊûúÂºπÂá∫ÊòæÁ§∫
    const resultPopupVisible = ref(false)

    // ÂÆöÊó∂Âô®ÁÆ°ÁêÜ
    const extensionRefreshTimer = ref(null)
    const autoExecuteTimer = ref(null)
    
    // ËÆæÁΩÆÁõ∏ÂÖ≥
    const showSettings = ref(false)
    const workspaceSettings = reactive({
      // Âà∑Êñ∞ËÆæÁΩÆ
      autoRefreshExtensions: false,
      extensionRefreshInterval: 60,
      autoReExecute: false,
      reExecuteInterval: 30,
      // ÊòæÁ§∫ËÆæÁΩÆ
      showExecutionTime: true,
      enableNotifications: true,
      defaultResultView: 'auto',
      themeMode: 'light',
      sidebarWidth: 320,
      resultAreaHeight: 600,
      defaultResultDisplay: 'auto',
      // ÊÄßËÉΩËÆæÁΩÆ
      cacheResults: true,
      cacheTimeout: 5,
      maxConcurrency: 3,
      executionTimeout: 60
    })

    // ‰ªélocalStorageÂä†ËΩΩËÆæÁΩÆ
    const loadSettings = () => {
      const savedSettings = localStorage.getItem('workspace-settings')
      if (savedSettings) {
        try {
          const parsed = JSON.parse(savedSettings)
          Object.assign(workspaceSettings, parsed)
        } catch (error) {
          console.error('Failed to load settings:', error)
        }
      }
    }

    // ‰øùÂ≠òËÆæÁΩÆÂà∞localStorage
    const saveSettingsToStorage = () => {
      localStorage.setItem('workspace-settings', JSON.stringify(workspaceSettings))
    }

    // ËÆ°ÁÆóÂ±ûÊÄß
    const hasResult = computed(() => {
      return resultData.value !== null || executionError.value
    })

    const canCopyResult = computed(() => {
      return ['text', 'html'].includes(resultType.value)
    })

    const canDownloadResult = computed(() => {
      return ['file', 'image', 'chart', 'table'].includes(resultType.value)
    })

    // Ê†∑ÂºèËÆ°ÁÆóÂ±ûÊÄß
    const sidebarStyle = computed(() => ({
      width: `${workspaceSettings.sidebarWidth}px`,
      minWidth: `${workspaceSettings.sidebarWidth}px`
    }))

    const resultContentStyle = computed(() => ({
      maxHeight: `${workspaceSettings.resultAreaHeight}px`
    }))

    const themeClass = computed(() => {
      if (workspaceSettings.themeMode === 'auto') {
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'theme-dark' : 'theme-light'
      }
      return `theme-${workspaceSettings.themeMode}`
    })

    // ÂõæË°®Áõ∏ÂÖ≥ËÆ°ÁÆóÂ±ûÊÄß
    const chartCanvasStyle = computed(() => ({
      width: '100%',
      height: chartFullscreen.value ? '70vh' : '400px'
    }))

    const chartTableData = computed(() => {
      if (!resultData.value?.chart_data?.datasets) return []

      const chartData = resultData.value.chart_data
      const labels = chartData.labels || []
      const datasets = chartData.datasets || []

      return labels.map((label, index) => {
        const row = { Ê†áÁ≠æ: label }
        datasets.forEach(dataset => {
          row[dataset.label || 'Êï∞ÊçÆ'] = dataset.data[index]
        })
        return row
      })
    })

    const chartTableColumns = computed(() => {
      if (!resultData.value?.chart_data?.datasets) return []

      const columns = [{ prop: 'Ê†áÁ≠æ', label: 'Ê†áÁ≠æ' }]
      const datasets = resultData.value.chart_data.datasets || []

      datasets.forEach(dataset => {
        columns.push({
          prop: dataset.label || 'Êï∞ÊçÆ',
          label: dataset.label || 'Êï∞ÊçÆ'
        })
      })

      return columns
    })

    // Ë°®Ê†ºÁõ∏ÂÖ≥ËÆ°ÁÆóÂ±ûÊÄß
    const tableColumns = computed(() => {
      if (!resultData.value || !Array.isArray(resultData.value) || resultData.value.length === 0) {
        return []
      }

      const firstRow = resultData.value[0]
      return Object.keys(firstRow).map(key => {
        const column = {
          prop: key,
          label: key,
          sortable: true,
          width: undefined
        }

        // Ê†πÊçÆÊï∞ÊçÆÁ±ªÂûãËÆæÁΩÆÂàóÂ±ûÊÄß
        const value = firstRow[key]
        if (typeof value === 'number') {
          column.type = 'number'
          column.width = 120
        } else if (key.includes('Áä∂ÊÄÅ') || key.includes('status') || key.toLowerCase().includes('state')) {
          column.type = 'status'
          column.width = 100
        } else if (typeof value === 'string' && value.length > 50) {
          column.width = 200
        }

        return column
      })
    })

    const sortedTableData = computed(() => {
      if (!resultData.value || !Array.isArray(resultData.value)) return []

      if (!tableSortConfig.value.prop) return resultData.value

      const { prop, order } = tableSortConfig.value
      return [...resultData.value].sort((a, b) => {
        const aVal = a[prop]
        const bVal = b[prop]

        if (typeof aVal === 'number' && typeof bVal === 'number') {
          return order === 'ascending' ? aVal - bVal : bVal - aVal
        }

        const aStr = String(aVal).toLowerCase()
        const bStr = String(bVal).toLowerCase()

        if (order === 'ascending') {
          return aStr.localeCompare(bStr)
        } else {
          return bStr.localeCompare(aStr)
        }
      })
    })

    const paginatedTableData = computed(() => {
      const start = (tableCurrentPage.value - 1) * tablePageSize.value
      const end = start + tablePageSize.value
      return sortedTableData.value.slice(start, end)
    })

    // ÊñπÊ≥ï
    const refreshExtensions = async () => {
      try {
        loading.value = true
        const response = await getExtensions()
        extensions.value = response.data.filter(ext => ext.enabled && ext.show_in_home)
        ElMessage.success(`Âä†ËΩΩ‰∫Ü ${extensions.value.length} ‰∏™Êâ©Â±ï`)
      } catch (error) {
        ElMessage.error('Âä†ËΩΩÊâ©Â±ïÂ§±Ë¥•: ' + error.message)
      } finally {
        loading.value = false
      }
    }

    const selectExtension = async (extension) => {
      console.log('ÈÄâÊã©Êâ©Â±ï:', extension)
      selectedExtension.value = extension
      clearResult()

      if (extension.has_query_form) {
        console.log('Êâ©Â±ïÊúâÊü•ËØ¢Ë°®ÂçïÔºåÂºÄÂßãÂä†ËΩΩ...')
        await loadQueryForm(extension.id)
      } else {
        console.log('Êâ©Â±ïÊ≤°ÊúâÊü•ËØ¢Ë°®Âçï')
      }
    }

    const loadQueryForm = async (extensionId) => {
      try {
        loadingForm.value = true
        formError.value = ''
        const response = await getExtensionQueryForm(extensionId)
        // ÂêéÁ´ØËøîÂõûÁöÑÂ≠óÊÆµÂêçÊòØquery_formÔºå‰∏çÊòØform_html
        queryFormHtml.value = response.data.query_form || response.data.form_html
        console.log('Âä†ËΩΩÊü•ËØ¢Ë°®ÂçïÊàêÂäü:', queryFormHtml.value)
      } catch (error) {
        console.error('Âä†ËΩΩÊü•ËØ¢Ë°®ÂçïÂ§±Ë¥•:', error)
        formError.value = 'Âä†ËΩΩÊü•ËØ¢Ë°®ÂçïÂ§±Ë¥•: ' + error.message
      } finally {
        loadingForm.value = false
      }
    }

    const executeExtension = async () => {
      if (!selectedExtension.value) return

      try {
        executing.value = true
        executionError.value = ''
        executionProgress.value = 0
        executionText.value = 'ÂáÜÂ§áÊâßË°å...'

        // Ê®°ÊãüÊâßË°åËøõÂ∫¶
        const progressInterval = setInterval(() => {
          if (executionProgress.value < 90) {
            executionProgress.value += 10
            updateExecutionText()
          }
        }, 200)

        // Êî∂ÈõÜË°®ÂçïÊï∞ÊçÆ
        const formData = collectFormData()

        // ÊâßË°åÊü•ËØ¢
        const response = await executeExtensionQuery(selectedExtension.value.id, formData)

        clearInterval(progressInterval)
        executionProgress.value = 100
        executionText.value = 'ÊâßË°åÂÆåÊàê'

        // Â§ÑÁêÜÁªìÊûú - executeExtensionQueryÂ∑≤ÁªèËøîÂõû‰∫ÜdataÈÉ®ÂàÜ
        handleExecutionResult(response)

        if (workspaceSettings.enableNotifications) {
          ElMessage.success('Êâ©Â±ïÊâßË°åÊàêÂäü')
        }

      } catch (error) {
        executionError.value = 'ÊâßË°åÂ§±Ë¥•: ' + error.message
        ElMessage.error('ÊâßË°åÂ§±Ë¥•: ' + error.message)
      } finally {
        executing.value = false
      }
    }

    const collectFormData = () => {
      const formData = {}
      if (selectedExtension.value.has_query_form) {
        // Êü•ÊâæË°®ÂçïÂÆπÂô®
        const formContainer = document.querySelector('.form-content')
        if (formContainer) {
          // Êî∂ÈõÜÊâÄÊúâËæìÂÖ•ÂÖÉÁ¥†ÁöÑÂÄº
          const inputs = formContainer.querySelectorAll('input, select, textarea')
          inputs.forEach(input => {
            if (input.name) {
              if (input.type === 'checkbox') {
                formData[input.name] = input.checked
              } else if (input.type === 'radio') {
                if (input.checked) {
                  formData[input.name] = input.value
                }
              } else {
                formData[input.name] = input.value
              }
            }
          })
          console.log('Êî∂ÈõÜÂà∞ÁöÑË°®ÂçïÊï∞ÊçÆ:', formData)
        }
      }
      return formData
    }

    const handleExecutionResult = (result) => {
      console.log('Â§ÑÁêÜÊâßË°åÁªìÊûú:', result)

      // Ê£ÄÊü•ÊòØÂê¶ÊòØÊàë‰ª¨‰øÆÂ§çÂêéÁöÑÊâ©Â±ïËøîÂõûÁöÑÊ†áÂáÜÊ†ºÂºè
      if (result && typeof result === 'object' && result.type && result.data !== undefined) {
        // Ê†áÂáÜÊâ©Â±ïËøîÂõûÊ†ºÂºè: {type: "html", data: "...", meta: {...}}
        resultType.value = result.type
        resultData.value = result.data
        resultMeta.value = result.meta || null
        console.log('‰ΩøÁî®Ê†áÂáÜÊ†ºÂºè:', resultType.value)

        // Â¶ÇÊûúÊòØÂõæË°®Á±ªÂûãÔºåÊ∏≤ÊüìÂõæË°®
        if (result.type === 'chart') {
          nextTick(() => {
            renderChart()
          })
        }

        // Ê†πÊçÆËÆæÁΩÆÂÜ≥ÂÆöÊòØÂê¶Ëá™Âä®ÂºπÂá∫ÊòæÁ§∫
        checkAutoPopup()
      } else {
        // ÂÖºÂÆπÊóßÊ†ºÂºèÊàñÂÖ∂‰ªñÊï∞ÊçÆ - Ê†πÊçÆÊâ©Â±ïÁöÑrender_typeÊù•Âà§Êñ≠Â¶Ç‰ΩïÊòæÁ§∫
        const renderType = selectedExtension.value?.render_type || 'text'
        resultType.value = renderType
        resultData.value = result
        resultMeta.value = null
        console.log('‰ΩøÁî®ÂÖºÂÆπÊ†ºÂºèÔºårender_type:', renderType)

        // Â¶ÇÊûúÊòØÂõæË°®Á±ªÂûãÔºåÊ∏≤ÊüìÂõæË°®
        if (renderType === 'chart') {
          nextTick(() => {
            renderChart()
          })
        }
      }
    }

    const updateExecutionText = () => {
      const texts = [
        'ÂàùÂßãÂåñÊâ©Â±ï...',
        'Âä†ËΩΩÈÖçÁΩÆ...',
        'Â§ÑÁêÜÂèÇÊï∞...',
        'ÊâßË°åÊü•ËØ¢...',
        'Â§ÑÁêÜÁªìÊûú...',
        'Ê∏≤ÊüìÊï∞ÊçÆ...'
      ]
      const index = Math.floor(executionProgress.value / 15)
      executionText.value = texts[index] || 'Â§ÑÁêÜ‰∏≠...'
    }

    const clearResult = () => {
      resultType.value = ''
      resultData.value = null
      resultMeta.value = null
      executionError.value = ''
      executionProgress.value = 0

      // Ê∏ÖÁêÜÂõæË°®
      if (chartInstance.value) {
        chartInstance.value.destroy()
        chartInstance.value = null
      }
      if (popupChartInstance.value) {
        popupChartInstance.value.destroy()
        popupChartInstance.value = null
      }
      chartError.value = ''
      showChartData.value = false
      chartFullscreen.value = false

      // ÂÖ≥Èó≠ÂºπÂá∫Á™óÂè£
      resultPopupVisible.value = false
    }

    const getExtensionIcon = (renderType) => {
      const iconMap = {
        'html': Document,
        'table': Grid,
        'image': Picture,
        'file': Folder,
        'chart': PieChart,
        'text': Memo
      }
      return iconMap[renderType] || Operation
    }

    const getTypeLabel = (renderType) => {
      const labelMap = {
        'html': 'HTMLÈ°µÈù¢',
        'table': 'Êï∞ÊçÆË°®Ê†º',
        'image': 'ÂõæÁâáÂõæË°®',
        'file': 'Êñá‰ª∂‰∏ãËΩΩ',
        'chart': '‰∫§‰∫íÂõæË°®',
        'text': 'ÊñáÊú¨Êä•Âëä'
      }
      return labelMap[renderType] || 'Êú™Áü•Á±ªÂûã'
    }

    const getTypeColor = (renderType) => {
      const colorMap = {
        'html': 'primary',
        'table': 'success',
        'image': 'warning',
        'file': 'info',
        'chart': 'danger',
        'text': ''
      }
      return colorMap[renderType] || 'info'
    }

    const getResultStatusType = () => {
      if (executionError.value) return 'danger'
      if (executing.value) return 'warning'
      return 'success'
    }

    const getResultStatusText = () => {
      if (executionError.value) return 'ÊâßË°åÂ§±Ë¥•'
      if (executing.value) return 'ÊâßË°å‰∏≠'
      return 'ÊâßË°åÊàêÂäü'
    }

    // ÁªìÊûúÊìç‰ΩúÊñπÊ≥ï
    const copyResult = () => {
      // ÂÆûÁé∞Â§çÂà∂ÂäüËÉΩ
      ElMessage.success('ÁªìÊûúÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
    }

    const downloadResult = () => {
      // ÂÆûÁé∞‰∏ãËΩΩÂäüËÉΩ
      ElMessage.success('ÂºÄÂßã‰∏ãËΩΩ')
    }

    const handleTableExport = (format) => {
      ElMessage.success(`ÂØºÂá∫‰∏∫ ${format} Ê†ºÂºè`)
    }

    const handleImageDownload = () => {
      ElMessage.success('ÂõæÁâá‰∏ãËΩΩ‰∏≠')
    }

    const handleFileDownload = () => {
      ElMessage.success('Êñá‰ª∂‰∏ãËΩΩ‰∏≠')
    }

    const handleChartExport = (format) => {
      ElMessage.success(`ÂõæË°®ÂØºÂá∫‰∏∫ ${format} Ê†ºÂºè`)
    }

    const handleTextCopy = () => {
      ElMessage.success('ÊñáÊú¨Â∑≤Â§çÂà∂')
    }

    const copyText = async () => {
      try {
        await navigator.clipboard.writeText(resultData.value)
        ElMessage.success('ÊñáÊú¨Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø')
      } catch (error) {
        ElMessage.error('Â§çÂà∂Â§±Ë¥•')
      }
    }

    // Ë°®Ê†ºÁõ∏ÂÖ≥ÊñπÊ≥ï
    const getTableRowCount = () => {
      return Array.isArray(resultData.value) ? resultData.value.length : 0
    }

    const handleTableSort = ({ prop, order }) => {
      tableSortConfig.value = { prop, order }
    }

    const handleTableSizeChange = (size) => {
      tablePageSize.value = size
      tableCurrentPage.value = 1
    }

    const handleTableCurrentChange = (page) => {
      tableCurrentPage.value = page
    }

    const formatNumber = (value) => {
      if (typeof value !== 'number') return value
      return value.toLocaleString()
    }

    const getStatusType = (status) => {
      const statusMap = {
        'Ê≠£Â∏∏': 'success',
        'ËøêË°å': 'success',
        'ËøêË°å‰∏≠': 'success',
        'running': 'success',
        'Ë≠¶Âëä': 'warning',
        'ÂºÇÂ∏∏': 'danger',
        'ÈîôËØØ': 'danger',
        'ÂÅúÊ≠¢': 'info',
        'Â∑≤ÂÅúÊ≠¢': 'info',
        'stopped': 'info'
      }
      return statusMap[status] || 'info'
    }

    const exportTableData = (format) => {
      if (!resultData.value || !Array.isArray(resultData.value)) {
        ElMessage.warning('Ê≤°ÊúâÊï∞ÊçÆÂèØÂØºÂá∫')
        return
      }

      try {
        if (format === 'csv') {
          exportTableToCsv()
        } else if (format === 'json') {
          exportTableToJson()
        }
      } catch (error) {
        ElMessage.error('ÂØºÂá∫Â§±Ë¥•: ' + error.message)
      }
    }

    const exportTableToCsv = () => {
      const headers = tableColumns.value.map(col => col.label).join(',')
      const rows = resultData.value.map(row =>
        tableColumns.value.map(col => {
          const value = row[col.prop]
          return typeof value === 'string' && value.includes(',')
            ? `"${value}"`
            : value
        }).join(',')
      )

      const csvContent = [headers, ...rows].join('\n')
      downloadFile(csvContent, 'table-data.csv', 'text/csv')
      ElMessage.success('CSVÊñá‰ª∂Â∑≤‰∏ãËΩΩ')
    }

    const exportTableToJson = () => {
      const jsonContent = JSON.stringify({
        data: resultData.value,
        meta: resultMeta.value,
        exported_at: new Date().toISOString()
      }, null, 2)

      downloadFile(jsonContent, 'table-data.json', 'application/json')
      ElMessage.success('JSONÊñá‰ª∂Â∑≤‰∏ãËΩΩ')
    }

    const downloadFile = (content, filename, mimeType) => {
      const blob = new Blob([content], { type: mimeType })
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = filename
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      URL.revokeObjectURL(url)
    }

    const toggleTableFullscreen = () => {
      tableFullscreen.value = !tableFullscreen.value
    }

    // ÁªìÊûúÂºπÂá∫ÊòæÁ§∫ÊñπÊ≥ï
    const toggleResultPopup = () => {
      resultPopupVisible.value = !resultPopupVisible.value

      // Â¶ÇÊûúÊòØÂõæË°®Á±ªÂûãÔºåÂú®ÂºπÂá∫Á™óÂè£‰∏≠ÈáçÊñ∞Ê∏≤Êüì
      if (resultPopupVisible.value && resultType.value === 'chart') {
        nextTick(() => {
          renderPopupChart()
        })
      }
    }

    const getPopupTitle = () => {
      const typeMap = {
        'html': 'HTMLÈ°µÈù¢',
        'table': 'Êï∞ÊçÆË°®Ê†º',
        'text': 'ÊñáÊú¨ÂÜÖÂÆπ',
        'chart': '‰∫§‰∫íÂõæË°®',
        'file': 'Êñá‰ª∂‰∏ãËΩΩ',
        'image': 'ÂõæÁâáÊü•Áúã'
      }
      return typeMap[resultType.value] || 'Êâ©Â±ïÁªìÊûú'
    }
    
    const formatFileSize = (bytes) => {
      if (!bytes || bytes === 0) return '0 B'
      const k = 1024
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB']
      const i = Math.floor(Math.log(bytes) / Math.log(k))
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
    }

    const checkAutoPopup = () => {
      const displayMode = workspaceSettings.defaultResultDisplay

      if (displayMode === 'popup') {
        // ÊÄªÊòØÂºπÂá∫ÊòæÁ§∫
        setTimeout(() => {
          resultPopupVisible.value = true
          if (resultType.value === 'chart') {
            nextTick(() => renderPopupChart())
          }
        }, 500)
      } else if (displayMode === 'auto') {
        // Ëá™Âä®Âà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÂºπÂá∫
        const shouldPopup = shouldAutoPopup()
        if (shouldPopup) {
          setTimeout(() => {
            resultPopupVisible.value = true
            if (resultType.value === 'chart') {
              nextTick(() => renderPopupChart())
            }
          }, 500)
        }
      }
      // inlineÊ®°Âºè‰∏çËá™Âä®ÂºπÂá∫
    }

    const shouldAutoPopup = () => {
      if (!resultData.value) return false

      // Ê†πÊçÆ‰∏çÂêåÁ±ªÂûãÂà§Êñ≠ÊòØÂê¶ÈúÄË¶ÅÂºπÂá∫
      switch (resultType.value) {
        case 'table':
          // Ë°®Ê†ºÊï∞ÊçÆË∂ÖËøá20Ë°åÊó∂ÂºπÂá∫
          return Array.isArray(resultData.value) && resultData.value.length > 20

        case 'text':
          // ÊñáÊú¨Ë∂ÖËøá1000Â≠óÁ¨¶Êàñ20Ë°åÊó∂ÂºπÂá∫
          const text = resultData.value || ''
          return text.length > 1000 || text.split('\n').length > 20

        case 'chart':
          // ÂõæË°®ÊÄªÊòØÂª∫ËÆÆÂºπÂá∫‰ª•Ëé∑ÂæóÊõ¥Â•ΩÁöÑ‰∫§‰∫í‰ΩìÈ™å
          return true

        case 'html':
          // HTMLÂÜÖÂÆπËæÉÈïøÊó∂ÂºπÂá∫
          const html = resultData.value || ''
          return html.length > 2000

        case 'image':
        case 'file':
          // ÂõæÁâáÂíåÊñá‰ª∂Âª∫ËÆÆÂºπÂá∫‰ª•Ëé∑ÂæóÊõ¥Â•ΩÁöÑÊü•Áúã‰ΩìÈ™å
          return true

        default:
          return false
      }
    }

    // ÂõæË°®Ê∏≤ÊüìÂáΩÊï∞
    const renderChart = async () => {
      if (!chartCanvas.value || !resultData.value) return

      try {
        chartLoading.value = true
        chartError.value = ''

        // Âä®ÊÄÅÂØºÂÖ•Chart.js
        const { Chart, registerables } = await import('chart.js')
        Chart.register(...registerables)

        // ÈîÄÊØÅÁé∞ÊúâÂõæË°®ÂÆû‰æã
        if (chartInstance.value) {
          chartInstance.value.destroy()
          chartInstance.value = null
        }

        // Ëé∑ÂèñÂõæË°®ÈÖçÁΩÆ
        const chartType = resultData.value.chart_type || 'line'
        const chartData = resultData.value.chart_data || {}
        const chartOptions = resultData.value.options || {}

        // ÂàõÂª∫Êñ∞ÁöÑÂõæË°®ÂÆû‰æã
        chartInstance.value = new Chart(chartCanvas.value, {
          type: chartType,
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            ...chartOptions,
            plugins: {
              ...chartOptions.plugins,
              legend: {
                display: true,
                position: 'top',
                ...chartOptions.plugins?.legend
              },
              tooltip: {
                enabled: true,
                ...chartOptions.plugins?.tooltip
              }
            },
            scales: {
              ...chartOptions.scales,
              y: {
                beginAtZero: true,
                ...chartOptions.scales?.y
              }
            }
          }
        })

        chartLoading.value = false
        console.log('ÂõæË°®Ê∏≤ÊüìÊàêÂäü')

      } catch (error) {
        chartLoading.value = false
        chartError.value = 'ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•: ' + error.message
        console.error('ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•:', error)
      }
    }

    const retryChart = () => {
      renderChart()
    }

    const exportChart = (format) => {
      if (!chartInstance.value) {
        ElMessage.error('ÂõæË°®Êú™ÂáÜÂ§áÂ∞±Áª™')
        return
      }

      try {
        if (format === 'png') {
          const url = chartInstance.value.toBase64Image()
          const link = document.createElement('a')
          link.href = url
          link.download = `chart-${Date.now()}.png`
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          ElMessage.success('ÂõæË°®Â∑≤ÂØºÂá∫‰∏∫PNG')
        }
      } catch (error) {
        ElMessage.error('ÂØºÂá∫Â§±Ë¥•: ' + error.message)
      }
    }

    const toggleChartFullscreen = () => {
      chartFullscreen.value = !chartFullscreen.value
      // Âª∂Ëøü‰∏Ä‰∏ãËÆ©DOMÊõ¥Êñ∞ÔºåÁÑ∂ÂêéÈáçÊñ∞Ê∏≤ÊüìÂõæË°®
      nextTick(() => {
        if (chartInstance.value) {
          chartInstance.value.resize()
        }
      })
    }

    // ÂºπÂá∫Á™óÂè£ÂõæË°®Áõ∏ÂÖ≥
    const popupChartCanvas = ref(null)
    const popupChartInstance = ref(null)

    const renderPopupChart = async () => {
      if (!popupChartCanvas.value || !resultData.value) return

      try {
        chartLoading.value = true
        chartError.value = ''

        // Âä®ÊÄÅÂØºÂÖ•Chart.js
        const { Chart, registerables } = await import('chart.js')
        Chart.register(...registerables)

        // ÈîÄÊØÅÁé∞ÊúâÂõæË°®ÂÆû‰æã
        if (popupChartInstance.value) {
          popupChartInstance.value.destroy()
          popupChartInstance.value = null
        }

        // Ëé∑ÂèñÂõæË°®ÈÖçÁΩÆ
        const chartType = resultData.value.chart_type || 'line'
        const chartData = resultData.value.chart_data || {}
        const chartOptions = resultData.value.options || {}

        // ÂàõÂª∫Êñ∞ÁöÑÂõæË°®ÂÆû‰æã
        popupChartInstance.value = new Chart(popupChartCanvas.value, {
          type: chartType,
          data: chartData,
          options: {
            responsive: true,
            maintainAspectRatio: false,
            ...chartOptions,
            plugins: {
              ...chartOptions.plugins,
              legend: {
                display: true,
                position: 'top',
                ...chartOptions.plugins?.legend
              },
              tooltip: {
                enabled: true,
                ...chartOptions.plugins?.tooltip
              }
            },
            scales: {
              ...chartOptions.scales,
              y: {
                beginAtZero: true,
                ...chartOptions.scales?.y
              }
            }
          }
        })

        chartLoading.value = false
        console.log('ÂºπÂá∫Á™óÂè£ÂõæË°®Ê∏≤ÊüìÊàêÂäü')

      } catch (error) {
        chartLoading.value = false
        chartError.value = 'ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•: ' + error.message
        console.error('ÂºπÂá∫Á™óÂè£ÂõæË°®Ê∏≤ÊüìÂ§±Ë¥•:', error)
      }
    }

    const retryPopupChart = () => {
      renderPopupChart()
    }

    const exportPopupChart = (format) => {
      if (!popupChartInstance.value) {
        ElMessage.error('ÂõæË°®Êú™ÂáÜÂ§áÂ∞±Áª™')
        return
      }

      try {
        if (format === 'png') {
          const url = popupChartInstance.value.toBase64Image()
          const link = document.createElement('a')
          link.href = url
          link.download = `chart-popup-${Date.now()}.png`
          document.body.appendChild(link)
          link.click()
          document.body.removeChild(link)
          ElMessage.success('ÂõæË°®Â∑≤ÂØºÂá∫‰∏∫PNG')
        }
      } catch (error) {
        ElMessage.error('ÂØºÂá∫Â§±Ë¥•: ' + error.message)
      }
    }

    const saveSettings = (newSettings) => {
      Object.assign(workspaceSettings, newSettings)
      saveSettingsToStorage()

      // ÈáçÊñ∞ÂêØÂä®ÂÆöÊó∂Âô®‰ª•Â∫îÁî®Êñ∞ËÆæÁΩÆ
      startTimers()

      ElMessage.success('ËÆæÁΩÆÂ∑≤‰øùÂ≠ò')
      showSettings.value = false
    }

    // ÂêØÂä®ÂÆöÊó∂Âô®
    const startTimers = () => {
      // Ê∏ÖÈô§Áé∞ÊúâÂÆöÊó∂Âô®
      stopTimers()

      // ËÆæÁΩÆËá™Âä®Âà∑Êñ∞Êâ©Â±ïÂàóË°®
      if (workspaceSettings.autoRefreshExtensions) {
        extensionRefreshTimer.value = setInterval(() => {
          refreshExtensions()
          console.log('Ëá™Âä®Âà∑Êñ∞Êâ©Â±ïÂàóË°®')
        }, workspaceSettings.extensionRefreshInterval * 1000)
      }

      // ËÆæÁΩÆËá™Âä®ÈáçÊñ∞ÊâßË°å
      if (workspaceSettings.autoReExecute) {
        autoExecuteTimer.value = setInterval(() => {
          autoReExecuteExtension()
        }, workspaceSettings.reExecuteInterval * 1000)
      }
    }

    // ÂÅúÊ≠¢ÂÆöÊó∂Âô®
    const stopTimers = () => {
      if (extensionRefreshTimer.value) {
        clearInterval(extensionRefreshTimer.value)
        extensionRefreshTimer.value = null
      }
      if (autoExecuteTimer.value) {
        clearInterval(autoExecuteTimer.value)
        autoExecuteTimer.value = null
      }
    }

    // ÁîüÂëΩÂë®Êúü
    onMounted(() => {
      loadSettings()
      refreshExtensions()
      startTimers()
    })

    onUnmounted(() => {
      // Ê∏ÖÁêÜÂÆöÊó∂Âô®
      stopTimers()

      // Ê∏ÖÁêÜÂõæË°®ÂÆû‰æã
      if (chartInstance.value) {
        chartInstance.value.destroy()
        chartInstance.value = null
      }
      if (popupChartInstance.value) {
        popupChartInstance.value.destroy()
        popupChartInstance.value = null
      }
    })

    // Ëá™Âä®ÈáçÊñ∞ÊâßË°åÊâ©Â±ï
    const autoReExecuteExtension = async () => {
      // Âè™ÊúâÂú®ÊúâÈÄâ‰∏≠Êâ©Â±ï‰∏îÊ≤°ÊúâÊ≠£Âú®ÊâßË°åÊó∂ÊâçËá™Âä®ÊâßË°å
      if (!selectedExtension.value || executing.value) {
        return
      }

      try {
        console.log(`Ëá™Âä®ÈáçÊñ∞ÊâßË°åÊâ©Â±ï: ${selectedExtension.value.name}`)

        // Â¶ÇÊûúÊâ©Â±ïÊúâÊü•ËØ¢Ë°®ÂçïÔºå‰ΩøÁî®ÂΩìÂâçË°®Âçï‰∏≠ÁöÑÊï∞ÊçÆ
        let formData = {}
        if (selectedExtension.value.has_query_form) {
          formData = collectFormData()
          console.log('‰ΩøÁî®ÂΩìÂâçË°®ÂçïÊï∞ÊçÆËøõË°åËá™Âä®ÊâßË°å:', formData)
        }

        // ËÆæÁΩÆËá™Âä®ÊâßË°åÁä∂ÊÄÅ
        isAutoExecuting.value = true
        executing.value = true
        executionProgress.value = 0
        executionError.value = ''

        // Ê®°ÊãüËøõÂ∫¶
        const progressInterval = setInterval(() => {
          if (executionProgress.value < 90) {
            executionProgress.value += Math.random() * 20
          }
        }, 200)

        executionText.value = 'üîÑ Ëá™Âä®ÊâßË°å‰∏≠...'

        // ÊâßË°åÊü•ËØ¢
        const response = await executeExtensionQuery(selectedExtension.value.id, formData)

        clearInterval(progressInterval)
        executionProgress.value = 100
        executionText.value = '‚úÖ Ëá™Âä®ÊâßË°åÂÆåÊàê'

        // Â§ÑÁêÜÁªìÊûú
        handleExecutionResult(response)

        if (workspaceSettings.enableNotifications) {
          ElMessage.success(`${selectedExtension.value.name} Ëá™Âä®ÊâßË°åÂÆåÊàê`)
        }

      } catch (error) {
        console.error('Ëá™Âä®ÊâßË°åÂ§±Ë¥•:', error)
        executionError.value = error.message || 'Ëá™Âä®ÊâßË°åÂ§±Ë¥•'
        executionText.value = '‚ùå Ëá™Âä®ÊâßË°åÂ§±Ë¥•'

        if (workspaceSettings.enableNotifications) {
          ElMessage.warning(`${selectedExtension.value.name} Ëá™Âä®ÊâßË°åÂ§±Ë¥•: ${error.message}`)
        }
      } finally {
        executing.value = false
        isAutoExecuting.value = false
      }
    }

    return {
      extensions,
      selectedExtension,
      loading,
      loadingForm,
      executing,
      executionProgress,
      executionText,
      isAutoExecuting,
      queryFormHtml,
      formError,
      resultType,
      resultData,
      resultMeta,
      executionError,
      showSettings,
      workspaceSettings,
      hasResult,
      canCopyResult,
      canDownloadResult,
      refreshExtensions,
      selectExtension,
      executeExtension,
      clearResult,
      getExtensionIcon,
      getTypeLabel,
      getTypeColor,
      copyResult,
      downloadResult,
      handleTableExport,
      handleImageDownload,
      handleFileDownload,
      handleChartExport,
      handleTextCopy,
      saveSettings,
      sidebarStyle,
      resultContentStyle,
      themeClass,
      loadSettings,
      saveSettingsToStorage,
      copyText,
      // ÂõæË°®Áõ∏ÂÖ≥
      chartCanvas,
      chartCanvasStyle,
      chartLoading,
      chartError,
      showChartData,
      chartTableData,
      chartTableColumns,
      renderChart,
      retryChart,
      exportChart,
      toggleChartFullscreen,
      // Ë°®Ê†ºÁõ∏ÂÖ≥
      tableCurrentPage,
      tablePageSize,
      tableFullscreen,
      tableColumns,
      paginatedTableData,
      getTableRowCount,
      handleTableSort,
      handleTableSizeChange,
      handleTableCurrentChange,
      formatNumber,
      getStatusType,
      exportTableData,
      toggleTableFullscreen,
      // ÂºπÂá∫ÊòæÁ§∫Áõ∏ÂÖ≥
      resultPopupVisible,
      toggleResultPopup,
      getPopupTitle,
      getResultStatusType,
      getResultStatusText,
      formatFileSize,
      popupChartCanvas,
      renderPopupChart,
      retryPopupChart,
      exportPopupChart,
      checkAutoPopup,
      shouldAutoPopup,
      autoReExecuteExtension,
      startTimers,
      stopTimers
    }
  }
}
</script>

<style scoped>
.modern-extension-view {
  height: 90vh;
  display: flex;
  flex-direction: column;
  background: #f5f7fa;
  width: 100%;
}

/* È°∂ÈÉ®ÂØºËà™Ê†è */
.top-navbar {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px 24px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
}

.navbar-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  max-width: 1400px;
  margin: 0 auto;
}

.navbar-left {
  display: flex;
  flex-direction: column;
}

.page-title {
  margin: 0;
  font-size: 24px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 12px;
}

.page-subtitle {
  font-size: 14px;
  opacity: 0.8;
  margin-top: 4px;
}

/* ‰∏ªË¶ÅÂÜÖÂÆπÂå∫Âüü */
.main-content {
  flex: 1;
  display: flex;
  max-width: 1400px;
  margin: 0 auto;
  width: 100%;
  gap: 24px;
  padding: 24px;
  overflow: hidden;
}

/* ‰æßËæπÊ†è */
.sidebar {
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: width 0.3s ease;
}

.sidebar-header {
  padding: 20px;
  background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  color: white;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sidebar-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

.extension-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.extension-item {
  display: flex;
  align-items: center;
  padding: 16px;
  margin: 4px 0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.extension-item:hover {
  background: #f8f9ff;
  transform: translateX(4px);
}

.extension-item.active {
  background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
  border-color: #667eea;
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
}

.extension-icon {
  width: 40px;
  height: 40px;
  border-radius: 8px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  margin-right: 12px;
}

.extension-info {
  flex: 1;
}

.extension-name {
  font-weight: 600;
  font-size: 14px;
  color: #2c3e50;
  margin-bottom: 4px;
}

.extension-type {
  font-size: 12px;
  color: #7f8c8d;
}

.extension-status {
  margin-left: 8px;
}

/* Â∑•‰ΩúÂå∫Âüü */
.workspace {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.empty-state {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.extension-workspace {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 24px;
  overflow: hidden;
}

/* Êâ©Â±ï‰ø°ÊÅØÂç°Áâá */
.extension-info-card {
  border-radius: 12px;
  box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.extension-title {
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.extension-title h2 {
  margin: 0 0 8px 0;
  font-size: 20px;
  font-weight: 600;
  color: #2c3e50;
}

.extension-description {
  margin: 0;
  color: #7f8c8d;
  font-size: 14px;
}

.extension-meta {
  display: flex;
  flex-direction: column;
  gap: 8px;
  align-items: flex-end;
}

/* Êü•ËØ¢Âå∫Âüü */
.query-section {
  margin-top: 20px;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.section-header h3 {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #2c3e50;
  display: flex;
  align-items: center;
  gap: 8px;
}

.query-form-container {
  background: #f8f9fa;
  border-radius: 8px;
  padding: 20px;
  min-height: 120px;
}

.loading-state,
.error-state,
.no-params {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 120px;
}

.form-content {
  background: white;
  border-radius: 6px;
  padding: 16px;
}

/* Êü•ËØ¢Ë°®ÂçïÊ†∑Âºè */
.form-content .form-group {
  margin-bottom: 16px;
}

.form-content .form-group label {
  display: block;
  margin-bottom: 6px;
  font-weight: 600;
  color: #495057;
}

.form-content .form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 14px;
  transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-content .form-control:focus {
  border-color: #667eea;
  outline: 0;
  box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
}

.form-content input[type="checkbox"] {
  margin-right: 8px;
}

.form-content .query-form {
  padding: 0;
}

/* ÁªìÊûúÂå∫Âüü */
.result-section {
  flex: 1;
  overflow: hidden;
}

.result-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.result-title {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 16px;
  font-weight: 600;
  color: #2c3e50;
  flex-wrap: wrap;
}

.result-title .el-tag {
  margin-left: 8px;
}

.result-title .el-tag .el-icon {
  margin-right: 4px;
}

.result-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.result-actions .el-button-group {
  display: flex;
  gap: 0;
}

.result-actions .el-button {
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 6px 12px;
  font-size: 12px;
  line-height: 1.4;
  white-space: nowrap;
}

.result-actions .el-button .el-icon {
  font-size: 14px;
  margin-right: 4px;
}

.result-actions .el-button span {
  display: inline-block;
}

/* Á°Æ‰øùÊåâÈíÆÊñáÂ≠óÊ≠£Á°ÆÊòæÁ§∫ */
.el-button-group .el-button {
  display: inline-flex !important;
  align-items: center !important;
  gap: 4px !important;
}

.el-button .el-icon + span,
.el-button .el-icon + * {
  margin-left: 4px;
    display: inline !important;  /* Ê∑ªÂä†Ëøô‰∏ÄË°å */

}

/* ‰øÆÂ§çÊåâÈíÆÊñáÂ≠óÂèØËÉΩË¢´ÈöêËóèÁöÑÈóÆÈ¢ò */
.el-button {
  overflow: visible !important;
  min-width: auto !important;
  width: auto !important;
}

/* Âº∫Âà∂ÊòæÁ§∫ÊåâÈíÆÊñáÂ≠ó - ‰ΩøÁî®Êõ¥È´ò‰ºòÂÖàÁ∫ß */
.result-actions .el-button span,
.el-button-group .el-button span,
.el-button span {
  opacity: 1 !important;
  visibility: visible !important;
  display: inline !important;
  color: inherit !important;
  font-size: 12px !important;
  line-height: 1.4 !important;
  white-space: nowrap !important;
}

/* Á°Æ‰øùÂõæÊ†áÂíåÊñáÂ≠óÈÉΩÊòæÁ§∫ */
.result-actions .el-button .el-icon,
.el-button-group .el-button .el-icon,
.el-button .el-icon {
  display: inline-block !important;
  margin-right: 4px !important;
  opacity: 1 !important;
  visibility: visible !important;
}

/* ÊåâÈíÆÂÜÖÂÆπÂÆπÂô® */
.result-actions .el-button,
.el-button-group .el-button {
  display: inline-flex !important;
  align-items: center !important;
  justify-content: center !important;
  gap: 4px !important;
  padding: 6px 12px !important;
  min-height: 28px !important;
  box-sizing: border-box !important;
}

/* ÊÇ¨ÂÅúÁä∂ÊÄÅÁ°Æ‰øùÊñáÂ≠óÊòæÁ§∫ */
.el-button:hover span,
.el-button:focus span,
.el-button:active span {
  opacity: 1 !important;
  visibility: visible !important;
  color: inherit !important;
}


.result-actions .el-button .el-icon {
  font-size: 14px !important;
  display: inline-block !important;
}

.result-actions .el-button span,
.result-actions .el-button > span {
  font-size: 12px !important;
  display: inline !important;
  opacity: 1 !important;
  visibility: visible !important;
  color: currentColor !important;
  margin-left: 4px !important;
}

/* Á°Æ‰øùÊåâÈíÆÂÜÖÂÆπÊ≠£Á°ÆÂ∏ÉÂ±Ä */
.result-actions .el-button-group .el-button {
  display: inline-flex !important;
  align-items: center !important;
  white-space: nowrap !important;
}

/* Âº∫Âà∂Ë¶ÜÁõñÂèØËÉΩÁöÑÈöêËóèÊ†∑Âºè */
.result-actions .el-button * {
  opacity: 1 !important;
  visibility: visible !important;
}

.result-content {
  max-height: 600px;
  overflow: auto;
}

/* ÊâßË°åÁä∂ÊÄÅ */
.executing-state {
  padding: 40px;
  text-align: center;
}

.execution-progress {
  max-width: 400px;
  margin: 0 auto;
}

.progress-text {
  margin-top: 16px;
  color: #7f8c8d;
  font-size: 14px;
}

/* ÁªìÊûúÊòæÁ§∫ */
.error-result,
.success-result {
  padding: 20px;
}

.html-content {
  background: white;
  border-radius: 6px;
  padding: 16px;
  border: 1px solid #e9ecef;
}

.raw-result {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 16px;
  margin-top: 16px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 12px;
  overflow: auto;
  max-height: 300px;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 1200px) {
  .main-content {
    flex-direction: column;
    gap: 16px;
  }

  .sidebar {
    width: 100%;
    max-height: 300px;
  }

  .extension-list {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    padding: 8px 16px;
  }

  .extension-item {
    min-width: 200px;
    flex-shrink: 0;
  }
}

@media (max-width: 768px) {
  .navbar-content {
    flex-direction: column;
    gap: 16px;
    text-align: center;
  }

  .main-content {
    padding: 16px;
  }

  .card-header {
    flex-direction: column;
    gap: 16px;
    align-items: flex-start;
  }

  .extension-meta {
    align-items: flex-start;
  }
}

/* ‰∏ªÈ¢òÊ†∑Âºè */
.theme-dark {
  background: #1a1a1a;
  color: #e0e0e0;
}

.theme-dark .sidebar,
.theme-dark .extension-info-card,
.theme-dark .result-section .el-card {
  background: #2d2d2d;
  color: #e0e0e0;
}

.theme-dark .sidebar-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.theme-dark .extension-item {
  border-color: #404040;
}

.theme-dark .extension-item:hover {
  background: #3a3a3a;
}

.theme-dark .extension-item.active {
  background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
  border-color: #667eea;
}

.theme-dark .query-form-container,
.theme-dark .text-stats,
.theme-dark .image-info,
.theme-dark .chart-info {
  background: #3a3a3a;
}

.theme-dark .form-content,
.theme-dark .stat-item,
.theme-dark .info-item {
  background: #2d2d2d;
  border-color: #404040;
}

.theme-light {
  background: #f5f7fa;
  color: #2c3e50;
}

/* ÁªìÊûúÊòæÁ§∫Ê†∑Âºè */
.table-header,
.image-header,
.file-header,
.chart-header,
.text-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  margin-bottom: 16px;
}

.table-header h4,
.image-header h4,
.file-header h4,
.chart-header h4,
.text-header h4 {
  margin: 0;
  color: #2c3e50;
}

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 12px;
}

.table-meta {
  display: flex;
  gap: 8px;
  align-items: center;
}

.table-actions {
  display: flex;
  gap: 8px;
}

.table-container.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background: white;
  padding: 20px;
}

.table-pagination {
  display: flex;
  justify-content: center;
  padding: 16px;
  background: #f8f9fa;
  border-top: 1px solid #e9ecef;
}

.number-cell {
  font-family: 'Monaco', 'Menlo', monospace;
  font-weight: 600;
  text-align: right;
}

.image-container {
  text-align: center;
  padding: 20px;
}

.file-info {
  padding: 20px;
}

.file-info p {
  margin: 8px 0;
}

.chart-placeholder {
  padding: 20px;
  background: #f8f9fa;
  border-radius: 6px;
  margin: 16px;
}

.chart-placeholder pre {
  background: white;
  padding: 16px;
  border-radius: 4px;
  border: 1px solid #e9ecef;
  max-height: 300px;
  overflow: auto;
}

.text-content {
  padding: 16px;
}

.text-content pre {
  background: #f8f9fa;
  padding: 16px;
  border-radius: 6px;
  border: 1px solid #e9ecef;
  max-height: 400px;
  overflow: auto;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 14px;
  line-height: 1.6;
}

.raw-result {
  background: #f8f9fa;
  border-radius: 6px;
  padding: 16px;
  margin-top: 16px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 12px;
  overflow: auto;
  max-height: 300px;
}

/* ÂõæË°®Ê†∑Âºè */
.chart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
  margin-bottom: 16px;
}

.chart-actions {
  display: flex;
  gap: 8px;
}

.chart-container {
  position: relative;
  padding: 20px;
  background: white;
  border-radius: 6px;
  margin: 16px;
}

.chart-loading,
.chart-error {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  color: #6c757d;
  z-index: 10;
}

.loading-icon,
.error-icon {
  font-size: 48px;
  margin-bottom: 16px;
}

.loading-icon {
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

.chart-data-table {
  margin-top: 20px;
  border-top: 1px solid #e9ecef;
}

.chart-data-table .table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: #f8f9fa;
  border-bottom: 1px solid #e9ecef;
}

.chart-data-table .table-header h5 {
  margin: 0;
  color: #2c3e50;
  font-size: 14px;
}

/* ÂõæË°®ÂÖ®Â±èÊ®°Âºè */
.chart-result.fullscreen {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 9999;
  background: white;
  padding: 20px;
}

.chart-result.fullscreen .chart-container {
  height: calc(100vh - 200px);
  margin: 0;
}

/* ÂºπÂá∫ÊòæÁ§∫ÂØπËØùÊ°ÜÊ†∑Âºè */
.result-popup-dialog {
  --el-dialog-padding-primary: 0;
  ;
}

.result-popup-dialog :deep(.el-dialog__body) {
  padding: 0;
  max-height: 85vh;
  overflow: hidden;
}

.popup-result-container {
  display: flex;
  flex-direction: column;
}

.popup-toolbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-bottom: 1px solid #e9ecef;
}

.popup-toolbar-left {
  display: flex;
  gap: 12px;
  align-items: center;
}


.popup-toolbar-right {
  display: flex;
  gap: 8px;
}

.popup-content {
  top: 4vh;
  flex: 1;
  overflow: auto;
  background: #f8f9fa;
}

/* ÂºπÂá∫Á™óÂè£HTMLÁªìÊûú */
.popup-html-result {
  padding: 24px;
  overflow: auto;
}

.popup-html-content {
  background: white;
  border-radius: 8px;
  padding: 20px;
  min-height: 100%;
}

/* ÂºπÂá∫Á™óÂè£Ë°®Ê†ºÁªìÊûú */
.popup-table-result {
  padding: 20px;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.popup-table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 12px 16px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.popup-table-pagination {
  display: flex;
  justify-content: center;
  padding: 16px;
  background: white;
  border-radius: 0 0 6px 6px;
  margin-top: 16px;
}

/* ÂºπÂá∫Á™óÂè£ÂõæË°®ÁªìÊûú */
.popup-chart-result {
  padding: 20px;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.popup-chart-container {
  position: relative;
  flex: 1;
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 16px;
}

.popup-chart-actions {
  display: flex;
  justify-content: center;
  gap: 12px;
  margin-bottom: 16px;
}

.popup-chart-data {
  background: white;
  border-radius: 8px;
  padding: 16px;
}

/* ÂºπÂá∫Á™óÂè£ÊñáÊú¨ÁªìÊûú */
.popup-text-result {
  padding: 20px;
  height: 100%;
  display: flex;
  flex-direction: column;
}

.popup-text-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
  padding: 12px 16px;
  background: white;
  border-radius: 6px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.popup-text-content {
  flex: 1;
  background: white;
  border-radius: 8px;
  padding: 20px;
  overflow: auto;
}

.popup-text-content pre {
  margin: 0;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 14px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
}

/* ÂºπÂá∫Á™óÂè£ÂõæÁâáÁªìÊûú */
.popup-image-result {
  padding: 20px;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.popup-image-container {
  max-width: 100%;
  max-height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.popup-image {
  max-width: 100%;
  max-height: 70vh;
  object-fit: contain;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* ÂºπÂá∫Á™óÂè£Êñá‰ª∂ÁªìÊûú */
.popup-file-result {
  padding: 40px;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

.popup-file-info {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  background: white;
  border-radius: 12px;
  padding: 40px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  max-width: 400px;
}

.popup-file-info .file-icon {
  color: #409eff;
  margin-bottom: 20px;
}

.popup-file-info h3 {
  margin: 0 0 16px 0;
  color: #2c3e50;
}

.popup-file-info p {
  margin: 8px 0;
  color: #6c757d;
}

.popup-file-info .file-actions {
  margin-top: 24px;
}

/* ÂºπÂá∫Á™óÂè£Êú™Áü•ÁªìÊûú */
.popup-unknown-result {
  padding: 20px;
  height: 100%;
}

.popup-raw-result {
  background: white;
  border-radius: 8px;
  padding: 20px;
  margin-top: 16px;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 12px;
  overflow: auto;
  max-height: 60vh;
}

/* ÂìçÂ∫îÂºèËÆæËÆ° */
@media (max-width: 768px) {
  .result-popup-dialog {
    width: 95% !important;
  }

  .popup-toolbar {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }

  .popup-table-header,
  .popup-text-header {
    flex-direction: column;
    gap: 12px;
    align-items: stretch;
  }
}
</style>

