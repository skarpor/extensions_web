# æƒé™éªŒè¯ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

æœ¬ç³»ç»Ÿé‡‡ç”¨åŸºäºè§’è‰²çš„è®¿é—®æ§åˆ¶ (RBAC) æ¨¡å‹ï¼Œæä¾›äº†å®Œæ•´çš„æƒé™éªŒè¯ä½“ç³»ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜å¦‚ä½•åœ¨APIæ¥å£ä¸­æ­£ç¡®æ·»åŠ æƒé™éªŒè¯ã€‚

## æƒé™éªŒè¯æ¶æ„

### 1. æƒé™å‘½åè§„èŒƒ

æƒé™é‡‡ç”¨ `æ¨¡å—:æ“ä½œ` çš„å‘½åè§„èŒƒï¼š

```
ç³»ç»Ÿç®¡ç†: system:manage
ç”¨æˆ·ç®¡ç†: user:create, user:read, user:update, user:delete
è§’è‰²ç®¡ç†: role:create, role:read, role:update, role:delete, role:manage
æ–‡ä»¶ç®¡ç†: file:upload, file:download, file:view, file:delete, file:manage
æ‰©å±•ç®¡ç†: extension:upload, extension:view, extension:update, extension:delete, extension:manage
èŠå¤©ç®¡ç†: chat:create, chat:read, chat:update, chat:delete
æ¶ˆæ¯ç®¡ç†: message:create, message:read, message:update, message:delete
```

### 2. æƒé™åˆ†ç»„ç»“æ„

```
ğŸ“ ç³»ç»Ÿç®¡ç† (system_management)
   â””â”€â”€ system:manage

ğŸ“ ç”¨æˆ·ç®¡ç† (user_management)
   â”œâ”€â”€ user:create
   â”œâ”€â”€ user:read
   â”œâ”€â”€ user:update
   â””â”€â”€ user:delete

ğŸ“ è§’è‰²æƒé™ç®¡ç† (role_management)
   â”œâ”€â”€ role:manage
   â”œâ”€â”€ role:create
   â”œâ”€â”€ role:read
   â”œâ”€â”€ role:update
   â””â”€â”€ role:delete

ğŸ“ æ–‡ä»¶ç®¡ç† (file_management)
   â”œâ”€â”€ file:manage
   â”œâ”€â”€ file:upload
   â”œâ”€â”€ file:download
   â”œâ”€â”€ file:view
   â””â”€â”€ file:delete

ğŸ“ æ‰©å±•ç®¡ç† (extension_management)
   â”œâ”€â”€ extension:manage
   â”œâ”€â”€ extension:upload
   â”œâ”€â”€ extension:view
   â”œâ”€â”€ extension:update
   â””â”€â”€ extension:delete

ğŸ“ èŠå¤©ç®¡ç† (chat_management)
   â”œâ”€â”€ chat:create
   â”œâ”€â”€ chat:read
   â”œâ”€â”€ chat:update
   â””â”€â”€ chat:delete

ğŸ“ æ¶ˆæ¯ç®¡ç† (message_management)
   â”œâ”€â”€ message:create
   â”œâ”€â”€ message:read
   â”œâ”€â”€ message:update
   â””â”€â”€ message:delete
```

## æƒé™éªŒè¯æ–¹æ³•

### 1. åŸºç¡€æƒé™éªŒè¯è£…é¥°å™¨

#### require_permissions(*permissions)
è¦æ±‚ç”¨æˆ·å…·æœ‰æ‰€æœ‰æŒ‡å®šæƒé™ï¼š

```python
from core.auth import require_permissions

# è¦æ±‚ç”¨æˆ·åŒæ—¶å…·æœ‰åˆ›å»ºå’Œæ›´æ–°ç”¨æˆ·çš„æƒé™
@require_permissions("user:create", "user:update")
def some_function(user: User = Depends(require_permissions("user:create", "user:update"))):
    pass
```

#### require_any_permission(*permissions)
è¦æ±‚ç”¨æˆ·å…·æœ‰ä»»æ„ä¸€ä¸ªæƒé™ï¼š

```python
from core.auth import require_any_permission

# ç”¨æˆ·åªéœ€è¦å…·æœ‰å…¶ä¸­ä»»æ„ä¸€ä¸ªæƒé™å³å¯
@require_any_permission("file:upload", "file:download", "file:view")
def some_function(user: User = Depends(require_any_permission("file:upload", "file:download", "file:view"))):
    pass
```

### 2. é¢„å®šä¹‰æƒé™éªŒè¯å‡½æ•°

ç³»ç»Ÿæä¾›äº†é¢„å®šä¹‰çš„æƒé™éªŒè¯å‡½æ•°ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼š

#### ç³»ç»Ÿç®¡ç†æƒé™
```python
from core.auth import manage_system

@router.get("/system/config")
async def get_system_config(
    current_user: User = Depends(manage_system)
):
    pass
```

#### ç”¨æˆ·ç®¡ç†æƒé™
```python
from core.auth import manage_users, create_users, view_users, update_users, delete_users

# ç»¼åˆç”¨æˆ·ç®¡ç†æƒé™ï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰
@router.post("/users")
async def create_user(
    current_user: User = Depends(create_users)
):
    pass

# æŸ¥çœ‹ç”¨æˆ·æƒé™
@router.get("/users")
async def get_users(
    current_user: User = Depends(view_users)
):
    pass

# æ›´æ–°ç”¨æˆ·æƒé™
@router.put("/users/{user_id}")
async def update_user(
    current_user: User = Depends(update_users)
):
    pass

# åˆ é™¤ç”¨æˆ·æƒé™
@router.delete("/users/{user_id}")
async def delete_user(
    current_user: User = Depends(delete_users)
):
    pass
```

#### æ–‡ä»¶ç®¡ç†æƒé™
```python
from core.auth import upload_files, download_files, view_files, delete_files, manage_files

# æ–‡ä»¶ä¸Šä¼ 
@router.post("/files/upload")
async def upload_file(
    current_user: User = Depends(upload_files)
):
    pass

# æ–‡ä»¶ä¸‹è½½
@router.get("/files/download/{file_id}")
async def download_file(
    current_user: User = Depends(download_files)
):
    pass

# æŸ¥çœ‹æ–‡ä»¶åˆ—è¡¨
@router.get("/files")
async def get_files(
    current_user: User = Depends(view_files)
):
    pass

# åˆ é™¤æ–‡ä»¶
@router.delete("/files/{file_id}")
async def delete_file(
    current_user: User = Depends(delete_files)
):
    pass
```

#### æ‰©å±•ç®¡ç†æƒé™
```python
from core.auth import upload_extensions, view_extensions, update_extensions, delete_extensions

# ä¸Šä¼ æ‰©å±•
@router.post("/extensions/upload")
async def upload_extension(
    current_user: User = Depends(upload_extensions)
):
    pass

# æŸ¥çœ‹æ‰©å±•
@router.get("/extensions")
async def get_extensions(
    current_user: User = Depends(view_extensions)
):
    pass

# æ›´æ–°æ‰©å±•
@router.put("/extensions/{ext_id}")
async def update_extension(
    current_user: User = Depends(update_extensions)
):
    pass

# åˆ é™¤æ‰©å±•
@router.delete("/extensions/{ext_id}")
async def delete_extension(
    current_user: User = Depends(delete_extensions)
):
    pass
```

## å®é™…åº”ç”¨ç¤ºä¾‹

### æ–‡ä»¶ç®¡ç†æ¥å£å®Œæ•´ç¤ºä¾‹

```python
from fastapi import APIRouter, Depends, HTTPException, UploadFile, File
from core.auth import upload_files, download_files, view_files, delete_files
from models.user import User

router = APIRouter()

@router.post("/upload")
async def upload_file(
    files: List[UploadFile] = File(...),
    current_user: User = Depends(upload_files),  # éªŒè¯ä¸Šä¼ æƒé™
    db: AsyncSession = Depends(get_db)
):
    """
    ä¸Šä¼ æ–‡ä»¶ - éœ€è¦ file:upload æƒé™
    """
    # æƒé™éªŒè¯å·²åœ¨ Depends(upload_files) ä¸­å®Œæˆ
    # è¿™é‡Œç›´æ¥å®ç°ä¸šåŠ¡é€»è¾‘
    pass

@router.get("/download/{file_id}")
async def download_file(
    file_id: int,
    current_user: User = Depends(download_files),  # éªŒè¯ä¸‹è½½æƒé™
    db: AsyncSession = Depends(get_db)
):
    """
    ä¸‹è½½æ–‡ä»¶ - éœ€è¦ file:download æƒé™
    """
    # æƒé™éªŒè¯å·²å®Œæˆï¼Œå®ç°ä¸‹è½½é€»è¾‘
    pass

@router.get("/")
async def get_files(
    current_user: User = Depends(view_files),  # éªŒè¯æŸ¥çœ‹æƒé™
    db: AsyncSession = Depends(get_db)
):
    """
    è·å–æ–‡ä»¶åˆ—è¡¨ - éœ€è¦ file:view æƒé™
    """
    # æƒé™éªŒè¯å·²å®Œæˆï¼Œè¿”å›æ–‡ä»¶åˆ—è¡¨
    pass

@router.delete("/{file_id}")
async def delete_file(
    file_id: int,
    current_user: User = Depends(delete_files),  # éªŒè¯åˆ é™¤æƒé™
    db: AsyncSession = Depends(get_db)
):
    """
    åˆ é™¤æ–‡ä»¶ - éœ€è¦ file:delete æƒé™
    """
    # æƒé™éªŒè¯å·²å®Œæˆï¼Œå®ç°åˆ é™¤é€»è¾‘
    
    # é¢å¤–çš„èµ„æºæ‰€æœ‰æƒæ£€æŸ¥ï¼ˆå¯é€‰ï¼‰
    file = await get_file_by_id(db, file_id)
    if not file:
        raise HTTPException(status_code=404, detail="æ–‡ä»¶ä¸å­˜åœ¨")
    
    # æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ˜¯æ–‡ä»¶æ‰€æœ‰è€…æˆ–è¶…çº§ç”¨æˆ·
    if file.owner_id != current_user.id and not current_user.is_superuser:
        raise HTTPException(status_code=403, detail="åªèƒ½åˆ é™¤è‡ªå·±çš„æ–‡ä»¶")
    
    # æ‰§è¡Œåˆ é™¤æ“ä½œ
    await delete_file_from_db(db, file_id)
    return {"message": "æ–‡ä»¶åˆ é™¤æˆåŠŸ"}
```

## æƒé™éªŒè¯æœ€ä½³å®è·µ

### 1. é€‰æ‹©åˆé€‚çš„æƒé™éªŒè¯æ–¹å¼

- **å•ä¸€æƒé™**ï¼šä½¿ç”¨é¢„å®šä¹‰å‡½æ•°ï¼Œå¦‚ `Depends(upload_files)`
- **å¤šä¸ªæƒé™ï¼ˆANDï¼‰**ï¼šä½¿ç”¨ `require_permissions("perm1", "perm2")`
- **å¤šä¸ªæƒé™ï¼ˆORï¼‰**ï¼šä½¿ç”¨ `require_any_permission("perm1", "perm2")`

### 2. èµ„æºæ‰€æœ‰æƒæ£€æŸ¥

é™¤äº†æƒé™éªŒè¯ï¼Œè¿˜éœ€è¦æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒè®¿é—®ç‰¹å®šèµ„æºï¼š

```python
@router.delete("/files/{file_id}")
async def delete_file(
    file_id: int,
    current_user: User = Depends(delete_files),
    db: AsyncSession = Depends(get_db)
):
    # 1. æƒé™éªŒè¯ï¼ˆå·²åœ¨ Depends ä¸­å®Œæˆï¼‰
    
    # 2. èµ„æºå­˜åœ¨æ€§æ£€æŸ¥
    file = await get_file_by_id(db, file_id)
    if not file:
        raise HTTPException(status_code=404, detail="æ–‡ä»¶ä¸å­˜åœ¨")
    
    # 3. èµ„æºæ‰€æœ‰æƒæ£€æŸ¥
    if file.owner_id != current_user.id and not current_user.is_superuser:
        raise HTTPException(status_code=403, detail="åªèƒ½åˆ é™¤è‡ªå·±çš„æ–‡ä»¶")
    
    # 4. æ‰§è¡Œæ“ä½œ
    await delete_file_logic(db, file_id)
```

### 3. è¶…çº§ç”¨æˆ·ç‰¹æƒ

ç³»ç»Ÿä¸­çš„è¶…çº§ç”¨æˆ· (`is_superuser=True`) è‡ªåŠ¨æ‹¥æœ‰æ‰€æœ‰æƒé™ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚

### 4. é”™è¯¯å¤„ç†

æƒé™éªŒè¯å¤±è´¥æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨è¿”å› `403 Forbidden` é”™è¯¯ï¼ŒåŒ…å«è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ã€‚

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•ä¸ºæ–°åŠŸèƒ½æ·»åŠ æƒé™ï¼Ÿ

1. åœ¨æƒé™åˆå§‹åŒ–ä¸­æ·»åŠ æ–°æƒé™
2. åˆ›å»ºå¯¹åº”çš„æƒé™éªŒè¯å‡½æ•°
3. åœ¨APIæ¥å£ä¸­ä½¿ç”¨æƒé™éªŒè¯

### Q: å¦‚ä½•å¤„ç†å¤æ‚çš„æƒé™é€»è¾‘ï¼Ÿ

å¯¹äºå¤æ‚çš„æƒé™é€»è¾‘ï¼Œå¯ä»¥åœ¨æ¥å£å†…éƒ¨è¿›è¡Œé¢å¤–çš„æƒé™æ£€æŸ¥ï¼š

```python
@router.post("/special-action")
async def special_action(
    current_user: User = Depends(get_current_active_user),
    db: AsyncSession = Depends(get_db)
):
    # å¤æ‚æƒé™é€»è¾‘
    if not (current_user.is_superuser or 
            ("admin" in [r.name for r in current_user.roles]) or
            ("special:action" in current_user.permissions)):
        raise HTTPException(status_code=403, detail="æƒé™ä¸è¶³")
    
    # æ‰§è¡Œæ“ä½œ
    pass
```

### Q: å¦‚ä½•è°ƒè¯•æƒé™é—®é¢˜ï¼Ÿ

1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·æœ‰æ‰€éœ€æƒé™
2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„æƒé™éªŒè¯ä¿¡æ¯
3. ä½¿ç”¨ `/api/auth/permissions` æ¥å£æŸ¥çœ‹å½“å‰ç”¨æˆ·æƒé™

## æ€»ç»“

é€šè¿‡ä½¿ç”¨æœ¬ç³»ç»Ÿçš„æƒé™éªŒè¯ä½“ç³»ï¼Œå¯ä»¥è½»æ¾å®ç°ç»†ç²’åº¦çš„æƒé™æ§åˆ¶ã€‚è®°ä½ä»¥ä¸‹è¦ç‚¹ï¼š

1. ä½¿ç”¨é¢„å®šä¹‰çš„æƒé™éªŒè¯å‡½æ•°
2. åœ¨éœ€è¦æ—¶è¿›è¡Œèµ„æºæ‰€æœ‰æƒæ£€æŸ¥
3. éµå¾ªæœ€å°æƒé™åŸåˆ™
4. ä¸ºæ–°åŠŸèƒ½åŠæ—¶æ·»åŠ ç›¸åº”æƒé™

è¿™æ ·å¯ä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚
