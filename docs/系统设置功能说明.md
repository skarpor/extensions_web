# 系统设置功能说明

## 概述

本系统实现了完整的配置管理功能，包括加密配置存储、过期时间控制、HTTP拦截器等。配置文件加密存储在用户家目录下，确保安全性和便携性。

## 功能特性

### 🔐 配置加密存储
- **存储位置**: `~/.extensions_web/app_config.enc`
- **加密方式**: 使用 Fernet 对称加密
- **密钥管理**: 自动生成并安全存储密钥文件
- **权限控制**: 配置文件仅所有者可读写

### ⏰ 自动过期控制
- **过期时间**: 首次启动后自动设置为3个月
- **自动检查**: HTTP拦截器自动检查每个请求
- **排除路径**: 登录、文档等关键路径不受限制
- **优雅降级**: 过期后仍可访问设置页面进行管理

### 🎨 人性化设置界面
- **现代化设计**: 卡片式布局，响应式设计
- **分类管理**: 按功能模块分组的标签页
- **实时状态**: 显示系统状态和剩余天数
- **安全管理**: 密钥单独管理，支持随机生成

## 配置项说明

### 基础配置
- **应用名称**: 系统显示名称
- **调试模式**: 开发调试开关
- **监听地址**: 服务器绑定地址
- **监听端口**: 服务器监听端口
- **时区设置**: 系统时区配置
- **语言设置**: 界面语言配置

### 安全配置
- **令牌过期时间**: JWT令牌有效期
- **加密算法**: 令牌签名算法
- **系统密钥**: JWT签名密钥（加密存储）

### 数据库配置
- **数据库类型**: SQLite/MySQL/PostgreSQL
- **连接URL**: 数据库连接字符串

### 文件配置
- **上传目录**: 文件存储路径
- **最大文件大小**: 上传限制（MB）
- **允许扩展名**: 支持的文件类型
- **扩展目录**: 插件存储路径
- **允许上传扩展**: 是否允许上传插件

### 用户配置
- **允许注册**: 是否开放用户注册
- **默认角色**: 新用户默认权限角色

### 邮件配置
- **SMTP服务器**: 邮件服务器地址
- **SMTP端口**: 邮件服务器端口
- **认证信息**: 用户名和密码
- **TLS加密**: 是否启用传输加密

### 日志配置
- **日志级别**: DEBUG/INFO/WARNING/ERROR/CRITICAL
- **日志文件**: 日志存储路径

## 技术实现

### 后端架构

#### 配置管理器 (`core/config_manager.py`)
```python
class ConfigManager:
    - 配置加密存储和读取
    - 默认配置初始化
    - 过期时间检查
    - 配置验证和更新
```

#### HTTP中间件 (`core/middleware.py`)
```python
class ExpiryCheckMiddleware:
    - 自动过期检查
    - 排除路径管理
    - 优雅错误处理

class SecurityHeadersMiddleware:
    - 安全头添加
    - XSS防护
    - 内容类型保护

class RequestLoggingMiddleware:
    - 请求日志记录
    - 性能监控
    - 错误追踪
```

#### API接口 (`api/v1/endpoints/system.py`)
```python
- GET /api/system/settings - 获取系统设置
- PUT /api/system/settings - 更新系统设置
- PUT /api/system/settings/secret-key - 更新密钥
- GET /api/system/expiry-info - 获取过期信息
- GET /api/system/config-status - 获取配置状态
```

### 前端界面

#### 系统设置页面 (`fr/src/views/settings/SystemSettingsView.vue`)
- **状态展示**: 系统运行状态、剩余天数、初始化时间
- **分类设置**: 7个功能模块的标签页
- **表单验证**: 实时验证和错误提示
- **密钥管理**: 安全的密钥设置对话框
- **响应式设计**: 适配桌面和移动端

## 安全特性

### 🔒 数据安全
- **配置加密**: 所有配置使用Fernet加密存储
- **密钥保护**: 加密密钥单独存储，权限受限
- **传输安全**: HTTPS支持，安全头保护
- **权限验证**: 仅超级管理员可访问设置

### 🛡️ 访问控制
- **过期检查**: 自动检查系统使用期限
- **路径排除**: 关键功能不受过期限制
- **优雅降级**: 过期后仍可进行必要管理
- **日志记录**: 完整的访问和操作日志

### 🔐 密钥管理
- **自动生成**: 支持随机密钥生成
- **安全存储**: 密钥不在界面显示
- **独立更新**: 密钥单独管理接口
- **强度验证**: 最小32位长度要求

## 使用指南

### 首次配置
1. **系统启动**: 首次启动自动创建默认配置
2. **过期设置**: 自动设置3个月过期时间
3. **密钥生成**: 自动生成加密密钥
4. **配置存储**: 加密保存到用户目录

### 日常管理
1. **访问设置**: 超级管理员登录后访问"高级设置"
2. **查看状态**: 实时查看系统状态和剩余天数
3. **修改配置**: 按需修改各模块配置参数
4. **保存设置**: 点击保存按钮应用更改

### 密钥管理
1. **查看状态**: 设置页面显示密钥是否已设置
2. **更新密钥**: 点击"更新密钥"按钮
3. **随机生成**: 使用"生成随机密钥"功能
4. **手动输入**: 输入自定义密钥（至少32位）

### 过期处理
1. **提前提醒**: 系统状态显示剩余天数
2. **过期限制**: 过期后大部分功能被限制
3. **紧急访问**: 仍可访问设置页面和登录
4. **续期操作**: 联系管理员或重新配置

## 配置文件结构

### 存储位置
```
~/.extensions_web/
├── app_config.enc    # 加密的配置文件
└── .key             # 加密密钥文件
```

### 配置内容
```json
{
  "APP_NAME": "Extensions Web",
  "DEBUG": false,
  "HOST": "0.0.0.0",
  "PORT": 8000,
  "SECRET_KEY": "...",
  "DATABASE_URL": "...",
  "EXPIRY_DATE": "2025-10-12T01:29:40.609000",
  "INITIALIZED_AT": "2025-07-13T01:29:40.609000",
  "UPDATED_AT": "2025-07-13T01:30:49.292000",
  ...
}
```

## 最佳实践

### 🔧 配置管理
- **定期备份**: 备份配置文件和密钥
- **版本控制**: 记录重要配置变更
- **测试验证**: 修改后测试系统功能
- **文档记录**: 记录自定义配置说明

### 🔐 安全建议
- **强密钥**: 使用随机生成的强密钥
- **权限控制**: 限制配置文件访问权限
- **定期更新**: 定期更换系统密钥
- **监控日志**: 关注配置相关的操作日志

### 📊 监控维护
- **状态检查**: 定期查看系统状态
- **性能监控**: 关注配置对性能的影响
- **错误处理**: 及时处理配置相关错误
- **容量规划**: 根据使用情况调整配置

## 故障排除

### 常见问题
1. **配置文件损坏**: 删除配置文件重新初始化
2. **密钥丢失**: 重新生成密钥和配置
3. **权限错误**: 检查文件系统权限
4. **过期问题**: 通过设置页面重新配置

### 恢复方法
1. **配置重置**: 删除 `~/.extensions_web` 目录
2. **手动修复**: 直接编辑配置文件（需解密）
3. **备份恢复**: 从备份恢复配置文件
4. **重新初始化**: 重启应用自动重建配置

## 总结

本系统设置功能提供了完整的配置管理解决方案，具有以下优势：

- ✅ **安全可靠**: 加密存储，权限控制
- ✅ **用户友好**: 现代化界面，分类管理
- ✅ **功能完整**: 覆盖所有配置需求
- ✅ **自动化**: 过期检查，默认配置
- ✅ **可扩展**: 易于添加新的配置项

通过这套配置管理系统，用户可以安全、便捷地管理系统的各项参数，确保系统稳定运行和安全使用。
